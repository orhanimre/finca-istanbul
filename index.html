<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pagos e Ingresos de Construcci√≥n</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 0;
        margin: 0;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .auth-container {
        display: flex;
        align-items: center;
        justify-content: center;
        min-height: 100vh;
        padding: 20px;
      }

      .auth-card {
        background: white;
        padding: 40px;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 400px;
        width: 100%;
      }

      .auth-card h1 {
        color: #333;
        margin-bottom: 10px;
        font-size: 28px;
      }

      .auth-card p {
        color: #666;
        margin-bottom: 30px;
        font-size: 16px;
      }

      .google-btn {
        width: 100%;
        padding: 14px 20px;
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        transition: all 0.3s;
      }

      .google-btn:hover {
        border-color: #667eea;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
      }

      .google-icon {
        width: 24px;
        height: 24px;
      }

      .user-info-bar {
        background: white;
        padding: 12px 15px;
        border-radius: 10px;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .user-email {
        font-size: 14px;
        color: #333;
        font-weight: 500;
      }

      .user-role {
        font-size: 12px;
        color: #666;
      }

      .signout-btn {
        padding: 6px 12px;
        background: #ff4444;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 13px;
        cursor: pointer;
        font-weight: 500;
      }

      .main-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
      }

      .main-tab {
        flex: 1;
        padding: 12px;
        background: white;
        border: none;
        border-radius: 10px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 4px;
      }

      .main-tab {
        background: #c0c0c0;
        color: #666;
      }

      .main-tab.active {
        background: #00ced1;
        color: white;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }

      .container {
        max-width: 100%;
        margin: 0;
        padding: 10px;
        padding-bottom: 30px;
      }

      @media (min-width: 768px) {
        .container {
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
        }
      }

      .header {
        background: white;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 10px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      }

      .header h1 {
        font-size: 20px;
        color: #333;
        margin-bottom: 10px;
      }

      .summary-tabs {
        display: flex;
        gap: 6px;
        margin-bottom: 10px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }

      .tab-btn {
        padding: 6px 12px;
        border: none;
        background: #f0f0f0;
        border-radius: 16px;
        font-size: 12px;
        cursor: pointer;
        white-space: nowrap;
        flex-shrink: 0;
      }

      .tab-btn.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .tab-btn.active.income-tab {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .total-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px;
        border-radius: 10px;
        text-align: center;
      }

      .total-box.income {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .total-label {
        font-size: 12px;
        opacity: 0.9;
        margin-bottom: 5px;
      }

      .total-amount {
        font-size: 28px;
        font-weight: bold;
      }

      .form-card {
        background: white;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 10px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        transition: background 0.3s ease;
      }

      #paymentFormCard {
        background: linear-gradient(
          135deg,
          #e0e7ff 0%,
          #c7d2fe 100%
        ) !important;
      }

      #incomeFormCard {
        background: linear-gradient(
          135deg,
          #d1fae5 0%,
          #a7f3d0 100%
        ) !important;
      }

      .form-title {
        font-size: 16px;
        font-weight: 600;
        color: #333;
        margin-bottom: 12px;
      }

      .form-group {
        margin-bottom: 12px;
      }

      .form-group label {
        display: block;
        font-size: 12px;
        color: #666;
        margin-bottom: 5px;
        font-weight: 500;
      }

      .form-group input,
      .form-group select,
      .form-group textarea {
        width: 100%;
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 15px;
        transition: border 0.3s;
        -webkit-appearance: none;
        appearance: none;
        font-family: inherit;
      }

      .form-group textarea {
        resize: vertical;
        min-height: 60px;
      }

      .form-group select {
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
        padding-right: 35px;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
      }

      .form-group input:focus,
      .form-group select:focus,
      .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
      }

      .add-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        box-shadow: 0 4px 10px rgba(102, 126, 234, 0.3);
      }

      .add-btn.income {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .update-btn {
        background: #4caf50;
        color: white;
        margin-bottom: 10px;
      }

      .cancel-btn {
        background: #f0f0f0;
        color: #333;
      }

      .btn:active {
        transform: scale(0.98);
      }

      .btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .controls {
        background: white;
        padding: 12px;
        border-radius: 10px;
        margin-bottom: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .sort-group {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .sort-group label {
        font-size: 12px;
        color: #666;
        font-weight: 500;
      }

      .sort-group select {
        flex: 1;
        padding: 8px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 13px;
      }

      .payments-list {
        margin-top: 10px;
        padding-bottom: 20px;
      }

      .payment-card-wrapper {
        position: relative;
        margin-bottom: 8px;
        border-radius: 10px;
        overflow: hidden;
      }

      .swipe-actions {
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        display: flex;
        z-index: 1;
      }

      .swipe-action {
        width: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .swipe-action.edit {
        background: #2196f3;
      }

      .swipe-action.delete {
        background: #ff4444;
      }

      .swipe-action:active {
        filter: brightness(0.9);
      }

      .payment-card {
        background: white;
        padding: 10px;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        position: relative;
        z-index: 2;
        transform: translateX(0);
        transition: transform 0.3s ease;
        cursor: pointer;
      }

      .payment-card-details {
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
      }

      .payment-card-details.expanded {
        max-height: 500px;
      }

      .payment-card-toggle {
        display: inline-block;
        margin-left: 8px;
        font-size: 12px;
        transition: transform 0.3s ease;
      }

      .payment-card-toggle.expanded {
        transform: rotate(180deg);
      }

      @media (max-width: 767px) {
        .payment-card {
          touch-action: pan-y;
        }

        .payment-card.swiped {
          transform: translateX(-160px);
        }

        .desktop-actions {
          display: none;
        }
      }

      @media (min-width: 768px) {
        .swipe-actions {
          display: none;
        }

        .desktop-actions {
          display: flex;
          gap: 6px;
          margin-top: 8px;
          padding-top: 8px;
          border-top: 1px solid #f0f0f0;
        }

        .desktop-action-btn {
          padding: 6px 12px;
          border: none;
          border-radius: 6px;
          font-size: 12px;
          cursor: pointer;
          font-weight: 500;
          display: flex;
          align-items: center;
          gap: 4px;
          transition: all 0.2s;
        }

        .desktop-action-btn.edit {
          background: #2196f3;
          color: white;
        }

        .desktop-action-btn.delete {
          background: #ff4444;
          color: white;
        }

        .desktop-action-btn:hover {
          transform: translateY(-1px);
          box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
      }

      .payment-number {
        position: absolute;
        top: 8px;
        left: 8px;
        background: #667eea;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: bold;
      }

      .payment-number.income {
        background: #10b981;
      }

      .payment-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
        padding-bottom: 6px;
        border-bottom: 2px solid #f0f0f0;
        padding-left: 32px;
      }

      .payment-sender {
        font-size: 13px;
        font-weight: 600;
        color: #333;
      }

      .payment-amount {
        font-size: 15px;
        font-weight: bold;
        color: #667eea;
      }

      .payment-amount.income {
        color: #10b981;
      }

      .payment-detail {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        font-size: 12px;
      }

      .payment-detail .label {
        color: #666;
      }

      .payment-detail .value {
        color: #333;
        font-weight: 500;
      }

      .date-separator {
        text-align: center;
        margin: 20px 0 12px 0;
        position: relative;
      }

      .date-separator-line {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(255, 255, 255, 0.3);
        z-index: 1;
      }

      .date-separator-text {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        position: relative;
        z-index: 2;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      }

      .date-separator-text.income {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      }

      .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: white;
      }

      .empty-state-icon {
        font-size: 60px;
        margin-bottom: 10px;
      }

      .loading {
        text-align: center;
        padding: 20px;
        color: white;
        font-size: 16px;
      }

      .floating-refresh {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 56px;
        height: 56px;
        background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
        color: white;
        border: none;
        border-radius: 50%;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        transition: all 0.3s ease;
      }

      .floating-refresh:active {
        transform: scale(0.95);
      }

      .floating-refresh:disabled {
        opacity: 0.6;
      }

      .floating-refresh.refreshing {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        from {
          transform: rotate(0deg);
        }

        to {
          transform: rotate(360deg);
        }
      }

      @media (max-width: 767px) {
        .budget-amount {
          font-size: 32px !important;
        }

        .budget-item-amount {
          font-size: 18px !important;
        }
      }

      @media print {
        body {
          background: white;
          padding: 20px;
        }
      }

      @media print {
        body {
          background: white;
          padding: 20px;
        }

        .container {
          max-width: 100%;
          padding: 0;
        }

        .form-card,
        .controls,
        .swipe-actions,
        .desktop-actions,
        .loading,
        .summary-tabs,
        .user-info-bar,
        .main-tabs,
        .floating-refresh,
        .print-button {
          display: none !important;
        }

        .header {
          box-shadow: none;
          border: 1px solid #ddd;
          page-break-inside: avoid;
        }

        .payment-card-wrapper {
          page-break-inside: avoid;
          margin-bottom: 15px;
        }

        .payment-card {
          box-shadow: none;
          border: 1px solid #ddd;
        }

        .total-box {
          background: white !important;
          color: black !important;
          border: 2px solid #667eea;
        }

        .payment-amount {
          color: black !important;
        }
      }
      /* Help button next to Notas */
      .help-icon {
        display: inline-block;
        width: 18px;
        height: 18px;
        background: #667eea;
        color: white;
        border-radius: 50%;
        text-align: center;
        line-height: 18px;
        font-size: 12px;
        font-weight: bold;
        cursor: pointer;
        margin-left: 6px;
        transition: all 0.3s;
        vertical-align: middle;
      }

      .help-icon:hover {
        background: #5568d3;
        transform: scale(1.1);
      }

      /* Help Modal/Popup */
      .help-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .help-modal.active {
        display: flex;
      }

      .help-modal-content {
        background: white;
        border-radius: 12px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .help-modal-header {
        padding: 20px;
        border-bottom: 2px solid #f0f0f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px 12px 0 0;
      }

      .help-modal-header h3 {
        font-size: 18px;
        margin: 0;
      }

      .help-modal-close {
        background: transparent;
        border: none;
        color: white;
        font-size: 24px;
        cursor: pointer;
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.3s;
      }

      .help-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .help-modal-body {
        padding: 20px;
      }

      .help-modal-body ul {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .help-modal-body li {
        padding: 8px 0;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
        color: #333;
      }

      .help-modal-body li:before {
        content: "‚Ä¢";
        color: #667eea;
        font-weight: bold;
        font-size: 18px;
        margin-right: 8px;
      }

      .help-modal-body li:last-child {
        border-bottom: none;
      }
    </style>
  </head>

  <body>
    <div id="authSection" style="display: none">
      <div class="auth-container">
        <div class="auth-card">
          <h1>üí∞ Pagos e Ingresos</h1>
          <p>Inicia sesi√≥n con tu cuenta de Google para acceder</p>
          <button onclick="signIn()" class="google-btn">
            <svg class="google-icon" viewBox="0 0 24 24">
              <path
                fill="#4285F4"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"
              />
              <path
                fill="#34A853"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"
              />
              <path
                fill="#FBBC05"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"
              />
              <path
                fill="#EA4335"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"
              />
            </svg>
            Iniciar sesi√≥n con Google
          </button>
        </div>
      </div>
    </div>

    <div id="mainContent" style="display: none">
      <div class="container">
        <div class="user-info-bar">
          <div class="user-info">
            <div>
              <div class="user-email" id="userEmail"></div>
              <div class="user-role" id="userRole"></div>
            </div>
          </div>
          <button onclick="signOutUser()" class="signout-btn">
            Cerrar sesi√≥n
          </button>
        </div>

        <div class="main-tabs">
          <button class="main-tab active" onclick="switchMainTab('budget')">
            <div>üí∞</div>
            <div>Presupuesto</div>
          </button>
          <button class="main-tab" onclick="switchMainTab('income')">
            <div>üíµ</div>
            <div>Ingresos</div>
          </button>
          <button class="main-tab" onclick="switchMainTab('payments')">
            <div>üí≥</div>
            <div>Pagos</div>
          </button>
        </div>

        <!-- BUDGET SECTION -->
        <div id="budgetSection">
          <div
            style="
              background: white;
              padding: 40px 20px;
              border-radius: 16px;
              box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
              text-align: center;
            "
          >
            <div style="font-size: 80px; margin-bottom: 20px">üí∞</div>
            <div
              style="
                font-size: 24px;
                color: #666;
                margin-bottom: 15px;
                font-weight: 600;
              "
            >
              Presupuesto Disponible
            </div>
            <div
              id="budgetAmount"
              style="
                font-size: 38px;
                font-weight: bold;
                color: #10b981;
                margin-bottom: 10px;
                word-break: break-word;
              "
            >
              $0
            </div>
            <div style="font-size: 11px; color: #999; margin-bottom: 30px">
              <div id="lastUpdatedIncome" style="margin-bottom: 3px">
                √öltima actualizaci√≥n de Ingresos: --
              </div>
              <div id="lastUpdatedPayments">
                √öltima actualizaci√≥n de Pagos: --
              </div>
            </div>

            <div
              style="
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #f0f0f0;
              "
            >
              <div style="text-align: center">
                <div style="font-size: 14px; color: #666; margin-bottom: 8px">
                  üíµ Total Ingresos
                </div>
                <div
                  id="budgetIncome"
                  style="font-size: 22px; font-weight: bold; color: #10b981"
                >
                  $0
                </div>
              </div>
              <div style="text-align: center">
                <div style="font-size: 14px; color: #666; margin-bottom: 8px">
                  üí≥ Total Pagos
                </div>
                <div
                  id="budgetPayments"
                  style="font-size: 22px; font-weight: bold; color: #667eea"
                >
                  $0
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- PAYMENTS SECTION -->
        <div id="paymentsSection" style="display: none">
          <div class="header">
            <div style="margin-bottom: 10px">
              <div
                style="
                  display: flex;
                  justify-content: flex-end;
                  gap: 8px;
                  margin-bottom: 6px;
                "
              >
                <button
                  onclick="exportToExcel('payments')"
                  class="print-button"
                  style="
                    padding: 8px;
                    background: transparent;
                    color: #10793f;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                  "
                  title="Exportar a Excel"
                >
                  ‚¨áÔ∏è
                </button>
                <button
                  onclick="printList('payments')"
                  class="print-button"
                  style="
                    padding: 8px;
                    background: transparent;
                    color: #2196f3;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                  "
                  title="Imprimir lista"
                >
                  üñ®Ô∏è
                </button>
              </div>
              <h1 style="margin: 0">üí∞ Pagos de Construcci√≥n</h1>
            </div>

            <div class="summary-tabs">
              <button
                class="tab-btn active"
                onclick="changeSummaryPeriod('all', 'payments')"
              >
                Todo
              </button>
              <button
                class="tab-btn"
                onclick="changeSummaryPeriod('today', 'payments')"
              >
                Hoy
              </button>
              <button
                class="tab-btn"
                onclick="changeSummaryPeriod('week', 'payments')"
              >
                Esta Semana
              </button>
              <button
                class="tab-btn"
                onclick="changeSummaryPeriod('month', 'payments')"
              >
                Este Mes
              </button>
              <button
                class="tab-btn"
                onclick="changeSummaryPeriod('year', 'payments')"
              >
                Este A√±o
              </button>
              <button
                class="tab-btn"
                onclick="changeSummaryPeriod('custom', 'payments')"
              >
                Personalizado
              </button>
            </div>

            <div
              id="customDateRangePayments"
              style="
                display: none;
                margin-bottom: 10px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
              "
            >
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  margin-bottom: 8px;
                "
              >
                <div>
                  <label
                    style="
                      font-size: 12px;
                      color: #333;
                      display: block;
                      margin-bottom: 4px;
                      font-weight: 600;
                    "
                    >Desde</label
                  >
                  <input
                    type="date"
                    id="customFromPayments"
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 2px solid #667eea;
                      border-radius: 6px;
                      font-size: 14px;
                      background: white;
                      color: #333;
                      -webkit-appearance: none;
                      -moz-appearance: none;
                      appearance: none;
                    "
                  />
                </div>
                <div>
                  <label
                    style="
                      font-size: 12px;
                      color: #333;
                      display: block;
                      margin-bottom: 4px;
                      font-weight: 600;
                    "
                    >Hasta</label
                  >
                  <input
                    type="date"
                    id="customToPayments"
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 2px solid #667eea;
                      border-radius: 6px;
                      font-size: 14px;
                      background: white;
                      color: #333;
                      -webkit-appearance: none;
                      -moz-appearance: none;
                      appearance: none;
                    "
                  />
                </div>
              </div>
              <button
                onclick="applyCustomRange('payments')"
                style="
                  width: 100%;
                  padding: 12px;
                  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                  border: none;
                  border-radius: 6px;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                  color: white;
                "
              >
                Aplicar Filtro
              </button>
            </div>

            <div
              class="total-box"
              style="display: flex; gap: 12px; align-items: center"
            >
              <div style="flex: 2; text-align: left">
                <div class="total-label" id="periodLabelPayments">
                  Total Pagado - Todo
                </div>
                <div class="total-amount" id="totalAmountPayments">$0.00</div>
              </div>
              <div
                style="
                  flex: 1;
                  text-align: center;
                  background: rgba(255, 255, 255, 0.2);
                  border-radius: 8px;
                  padding: 8px;
                "
              >
                <div class="label" style="font-size: 12px; opacity: 0.9">
                  Pagos
                </div>
                <div
                  class="value"
                  id="paymentCountPayments"
                  style="font-size: 20px; font-weight: bold"
                >
                  0
                </div>
              </div>
            </div>
          </div>

          <div class="form-card collapsed payment-form" id="paymentFormCard">
            <div
              class="form-title"
              id="formTitlePayments"
              onclick="toggleForm('payments')"
              style="
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>Agregar Nuevo Pago</span>
              <span id="formArrowPayments">‚ñº</span>
            </div>
            <form id="paymentForm" style="display: none">
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  margin-bottom: 12px;
                "
              >
                <div class="form-group" style="margin-bottom: 0">
                  <label>Fecha</label>
                  <input type="date" id="datePayments" required />
                </div>
                <div class="form-group" style="margin-bottom: 0">
                  <label>Hora</label>
                  <input type="time" id="timePayments" required />
                </div>
              </div>
              <div class="form-group">
                <label>Beneficiario</label>
                <input
                  type="text"
                  id="senderPayments"
                  placeholder="ej., Constructora ABC"
                  required
                />
              </div>
              <div class="form-group">
                <label>Concepto</label>
                <select
                  id="conceptPayments"
                  onchange="handleConceptChange()"
                  required
                >
                  <option value="">Seleccionar concepto</option>
                  <option>Mano de obra d√≠a</option>
                  <option>Materiales de construcci√≥n</option>
                  <option>Materiales de acabados</option>
                  <option>Materiales de carpinter√≠a</option>
                  <option>Materiales el√©ctricos</option>
                  <option>Materiales sanitarios</option>
                  <option>Flete/Transporte</option>
                  <option>Alquiler de equipos</option>
                  <option value="otro">Otro (especificar)</option>
                </select>
              </div>
              <div
                class="form-group"
                id="conceptOtherPayments"
                style="display: none"
              >
                <label>Especificar Concepto</label>
                <input
                  type="text"
                  id="conceptOtherInputPayments"
                  placeholder="Describe el concepto"
                />
              </div>
              <div class="form-group">
                <label>
                  Notas (Opcional)
                  <span
                    class="help-icon"
                    onclick="showHelpModal()"
                    title="Ver ejemplos"
                    >?</span
                  >
                </label>
                <textarea
                  id="notesPayments"
                  placeholder="Detalles adicionales del pago"
                ></textarea>
              </div>
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  margin-bottom: 12px;
                "
              >
                <div class="form-group" style="margin-bottom: 0">
                  <label>Categor√≠a</label>
                  <select id="categoryPayments" required>
                    <option value="">Seleccionar</option>
                    <option>Construcci√≥n</option>
                    <option>Materiales</option>
                    <option>Instalaciones</option>
                    <option>Log√≠stica</option>
                    <option>Equipos</option>
                    <option>Administrativo</option>
                    <option>Otros</option>
                  </select>
                </div>
                <div class="form-group" style="margin-bottom: 0">
                  <label>√Årea/Lugar</label>
                  <select id="locationPayments" required>
                    <option value="">Seleccionar</option>

                    <!-- PHASE 1: FOUNDATION & STRUCTURE -->
                    <option>Fundaci√≥n</option>
                    <!-- 1. Foundation first -->
                    <option>Estructura</option>
                    <!-- 3. Main structure/columns -->
                    <option>Paredes/Muros</option>
                    <!-- 4. Walls -->
                    <option>Techo</option>
                    <!-- 5. Roof -->
                    <option>Escaleras</option>
                    <!-- 6. Stairs -->

                    <!-- PHASE 2: INSTALLATIONS -->
                    <option>Instalaci√≥n el√©ctrica</option>
                    <!-- 7. Electrical rough-in -->
                    <option>Instalaci√≥n sanitaria</option>
                    <!-- 8. Plumbing rough-in -->

                    <!-- PHASE 3: INTERIOR FINISHING -->
                    <option>Pisos</option>
                    <!-- 9. Flooring -->
                    <option>Ba√±os</option>
                    <!-- 10. Bathrooms -->
                    <option>Cocina</option>
                    <!-- 11. Kitchen -->
                    <option>Habitaciones</option>
                    <!-- 12. Bedrooms -->
                    <option>Sala/Comedor</option>
                    <!-- 13. Living/Dining -->
                    <option>Ventanas/Puertas</option>
                    <!-- 14. Windows/Doors -->

                    <!-- PHASE 4: EXTERIOR FINISHING -->
                    <option>Fachada</option>
                    <!-- 15. Facade -->
                    <option>Garaje</option>
                    <!-- 16. Garage -->
                    <option>Patio/Terraza</option>
                    <!-- 17. Patio/Terrace -->
                    <option>Cerco perimetral</option>
                    <!-- 18. Perimeter fence -->
                    <option>Jardiner√≠a</option>
                    <!-- 19. Landscaping (last) -->

                    <!-- GENERAL OPTIONS -->
                    <option>General</option>
                    <!-- For multiple areas -->
                  </select>
                </div>
              </div>
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  margin-bottom: 12px;
                "
              >
                <div class="form-group" style="margin-bottom: 0">
                  <label>Cantidad</label>
                  <input
                    type="number"
                    id="quantityPayments"
                    placeholder="0"
                    step="0.01"
                    min="0"
                  />
                </div>
                <div class="form-group" style="margin-bottom: 0">
                  <label>Unidad</label>
                  <select id="unitPayments">
                    <option value="">Seleccionar</option>
                    <option>kg</option>
                    <option>lt</option>
                    <option>m</option>
                    <option>m¬≤</option>
                    <option>m¬≥</option>
                    <option>unidades</option>
                    <option>bolsas</option>
                    <option>cajas</option>
                    <option>d√≠as</option>
                    <option>horas</option>
                  </select>
                </div>
              </div>
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  margin-bottom: 12px;
                "
              >
                <div class="form-group" style="margin-bottom: 0">
                  <label>Monto ($)</label>
                  <input
                    type="number"
                    id="amountPayments"
                    placeholder="0"
                    step="0.01"
                    required
                  />
                </div>
                <div class="form-group" style="margin-bottom: 0">
                  <label>M√©todo de Pago</label>
                  <select id="methodPayments" required>
                    <option value="">Seleccionar</option>
                    <option>Transferencia</option>
                    <option>Efectivo</option>
                  </select>
                </div>
              </div>
              <div id="updateButtonsPayments" style="display: none">
                <button type="submit" class="btn update-btn">
                  Actualizar Pago
                </button>
                <button
                  type="button"
                  class="btn cancel-btn"
                  onclick="cancelEdit('payments')"
                >
                  Cancelar
                </button>
              </div>
              <button type="submit" class="btn add-btn" id="addButtonPayments">
                + Agregar Pago
              </button>
            </form>
          </div>

          <div class="controls">
            <div class="sort-group">
              <label>Ordenar por:</label>
              <select id="sortByPayments" onchange="sortData('payments')">
                <option value="date-desc">Fecha (M√°s reciente)</option>
                <option value="date-asc">Fecha (M√°s antigua)</option>
                <option value="amount-desc">Monto (Mayor a menor)</option>
                <option value="amount-asc">Monto (Menor a mayor)</option>
                <option value="sender">Beneficiario (A-Z)</option>
                <option value="category">Categor√≠a</option>
              </select>
            </div>
          </div>

          <div id="loadingIndicatorPayments" class="loading">
            Cargando pagos...
          </div>
          <div class="payments-list" id="paymentsListPayments"></div>
        </div>

        <!-- INCOME SECTION -->
        <div id="incomeSection" style="display: none">
          <div class="header">
            <div style="margin-bottom: 10px">
              <div
                style="
                  display: flex;
                  justify-content: flex-end;
                  gap: 8px;
                  margin-bottom: 6px;
                "
              >
                <button
                  onclick="exportToExcel('income')"
                  class="print-button"
                  style="
                    padding: 8px;
                    background: transparent;
                    color: #10793f;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                  "
                  title="Exportar a Excel"
                >
                  ‚¨áÔ∏è
                </button>
                <button
                  onclick="printList('income')"
                  class="print-button"
                  style="
                    padding: 8px;
                    background: transparent;
                    color: #2196f3;
                    border: none;
                    font-size: 24px;
                    cursor: pointer;
                  "
                  title="Imprimir lista"
                >
                  üñ®Ô∏è
                </button>
              </div>
              <h1 style="margin: 0">üíµ Ingresos Recibidos</h1>
            </div>

            <div class="summary-tabs">
              <button
                class="tab-btn income-tab active"
                onclick="changeSummaryPeriod('all', 'income')"
              >
                Todo
              </button>
              <button
                class="tab-btn income-tab"
                onclick="changeSummaryPeriod('today', 'income')"
              >
                Hoy
              </button>
              <button
                class="tab-btn income-tab"
                onclick="changeSummaryPeriod('week', 'income')"
              >
                Esta Semana
              </button>
              <button
                class="tab-btn income-tab"
                onclick="changeSummaryPeriod('month', 'income')"
              >
                Este Mes
              </button>
              <button
                class="tab-btn income-tab"
                onclick="changeSummaryPeriod('year', 'income')"
              >
                Este A√±o
              </button>
              <button
                class="tab-btn income-tab"
                onclick="changeSummaryPeriod('custom', 'income')"
              >
                Personalizado
              </button>
            </div>

            <div
              id="customDateRangeIncome"
              style="
                display: none;
                margin-bottom: 10px;
                padding: 10px;
                background: #f8f9fa;
                border-radius: 8px;
              "
            >
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  margin-bottom: 8px;
                "
              >
                <div>
                  <label
                    style="
                      font-size: 12px;
                      color: #333;
                      display: block;
                      margin-bottom: 4px;
                      font-weight: 600;
                    "
                    >Desde</label
                  >
                  <input
                    type="date"
                    id="customFromIncome"
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 2px solid #10b981;
                      border-radius: 6px;
                      font-size: 14px;
                      background: white;
                      color: #333;
                      -webkit-appearance: none;
                      -moz-appearance: none;
                      appearance: none;
                    "
                  />
                </div>
                <div>
                  <label
                    style="
                      font-size: 12px;
                      color: #333;
                      display: block;
                      margin-bottom: 4px;
                      font-weight: 600;
                    "
                    >Hasta</label
                  >
                  <input
                    type="date"
                    id="customToIncome"
                    style="
                      width: 100%;
                      padding: 10px;
                      border: 2px solid #10b981;
                      border-radius: 6px;
                      font-size: 14px;
                      background: white;
                      color: #333;
                      -webkit-appearance: none;
                      -moz-appearance: none;
                      appearance: none;
                    "
                  />
                </div>
              </div>
              <button
                onclick="applyCustomRange('income')"
                style="
                  width: 100%;
                  padding: 12px;
                  background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                  border: none;
                  border-radius: 6px;
                  font-size: 14px;
                  font-weight: 600;
                  cursor: pointer;
                  color: white;
                "
              >
                Aplicar Filtro
              </button>
            </div>

            <div
              class="total-box income"
              style="display: flex; gap: 12px; align-items: center"
            >
              <div style="flex: 2; text-align: left">
                <div class="total-label" id="periodLabelIncome">
                  Total Recibido - Todo
                </div>
                <div class="total-amount" id="totalAmountIncome">$0.00</div>
              </div>
              <div
                style="
                  flex: 1;
                  text-align: center;
                  background: rgba(255, 255, 255, 0.2);
                  border-radius: 8px;
                  padding: 8px;
                "
              >
                <div class="label" style="font-size: 12px; opacity: 0.9">
                  Ingresos
                </div>
                <div
                  class="value"
                  id="paymentCountIncome"
                  style="font-size: 20px; font-weight: bold"
                >
                  0
                </div>
              </div>
            </div>
          </div>

          <div class="form-card collapsed income-form" id="incomeFormCard">
            <div
              class="form-title"
              id="formTitleIncome"
              onclick="toggleForm('income')"
              style="
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
              "
            >
              <span>Agregar Nuevo Ingreso</span>
              <span id="formArrowIncome">‚ñº</span>
            </div>
            <form id="incomeForm" style="display: none">
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  margin-bottom: 12px;
                "
              >
                <div class="form-group" style="margin-bottom: 0">
                  <label>Fecha</label>
                  <input type="date" id="dateIncome" required />
                </div>
                <div class="form-group" style="margin-bottom: 0">
                  <label>Hora</label>
                  <input type="time" id="timeIncome" required />
                </div>
              </div>
              <div class="form-group">
                <label>Remitente</label>
                <select id="senderIncome" required>
                  <option value="">Seleccionar remitente</option>
                  <option>Marizuly Naranjo Parra</option>
                </select>
              </div>
              <div class="form-group">
                <label>Receptor</label>
                <select id="receiverIncome" required>
                  <option value="">Seleccionar receptor</option>
                  <option>Orhan IMRE</option>
                </select>
              </div>
              <div class="form-group">
                <label>Concepto</label>
                <select id="conceptIncome" required>
                  <option value="">Seleccionar concepto</option>
                  <option>Pago de construcci√≥n</option>
                </select>
              </div>
              <div class="form-group">
                <label>Notas (Opcional)</label>
                <textarea
                  id="notesIncome"
                  placeholder="Detalles adicionales del ingreso"
                ></textarea>
              </div>
              <div
                style="
                  display: grid;
                  grid-template-columns: 1fr 1fr;
                  gap: 8px;
                  margin-bottom: 12px;
                "
              >
                <div class="form-group" style="margin-bottom: 0">
                  <label>Monto ($)</label>
                  <input
                    type="number"
                    id="amountIncome"
                    placeholder="0"
                    step="0.01"
                    required
                  />
                </div>
                <div class="form-group" style="margin-bottom: 0">
                  <label>M√©todo</label>
                  <select id="methodIncome" required>
                    <option value="">Seleccionar</option>
                    <option>Transferencia</option>
                    <option>Efectivo</option>
                  </select>
                </div>
              </div>
              <div id="updateButtonsIncome" style="display: none">
                <button type="submit" class="btn update-btn">
                  Actualizar Ingreso
                </button>
                <button
                  type="button"
                  class="btn cancel-btn"
                  onclick="cancelEdit('income')"
                >
                  Cancelar
                </button>
              </div>
              <button
                type="submit"
                class="btn add-btn income"
                id="addButtonIncome"
              >
                + Agregar Ingreso
              </button>
            </form>
          </div>

          <div class="controls">
            <div class="sort-group">
              <label>Ordenar por:</label>
              <select id="sortByIncome" onchange="sortData('income')">
                <option value="date-desc">Fecha (M√°s reciente)</option>
                <option value="date-asc">Fecha (M√°s antigua)</option>
                <option value="amount-desc">Monto (Mayor a menor)</option>
                <option value="amount-asc">Monto (Menor a mayor)</option>
                <option value="sender">Remitente (A-Z)</option>
              </select>
            </div>
          </div>

          <div id="loadingIndicatorIncome" class="loading">
            Cargando ingresos...
          </div>
          <div class="payments-list" id="paymentsListIncome"></div>
        </div>
      </div>

      <!-- Floating Refresh Button -->
      <button
        id="floatingRefresh"
        class="floating-refresh"
        onclick="refreshData()"
        title="Actualizar datos"
      >
        üîÑ
      </button>

      <!-- Help Modal -->
      <div id="helpModal" class="help-modal" onclick="closeHelpModal(event)">
        <div class="help-modal-content" onclick="event.stopPropagation()">
          <div class="help-modal-header">
            <h3 id="helpModalTitle">üí° Ejemplos</h3>
            <button class="help-modal-close" onclick="closeHelpModal()">
              &times;
            </button>
          </div>
          <div class="help-modal-body">
            <ul id="helpModalList"></ul>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        updateDoc,
        deleteDoc,
        doc,
        query,
        orderBy,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
      import {
        getAuth,
        signInWithPopup,
        GoogleAuthProvider,
        signOut,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDocypAXYXHbqxRIrBv9VSXfeBCb29p83Y",
        authDomain: "finca-istanbul.firebaseapp.com",
        projectId: "finca-istanbul",
        storageBucket: "finca-istanbul.firebasestorage.app",
        messagingSenderId: "2342946040",
        appId: "1:2342946040:web:6b63ce44b12279c091270d",
        measurementId: "G-22VREQ36X8",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const auth = getAuth(app);
      const provider = new GoogleAuthProvider();

      let payments = [];
      let income = [];
      let editingId = null;
      let currentPeriodPayments = "all";
      let currentPeriodIncome = "all";
      let customDateFromPayments = null;
      let customDateToPayments = null;
      let customDateFromIncome = null;
      let customDateToIncome = null;
      let currentUser = null;
      let isAdmin = false;
      let currentTab = "budget";
      let paymentTimeInterval = null;
      let incomeTimeInterval = null;

      const ADMIN_EMAILS = ["orhanimre@gmail.com", "marizulynaranjo@gmail.com"];

      onAuthStateChanged(auth, (user) => {
        currentUser = user;
        isAdmin = user && ADMIN_EMAILS.includes(user.email);
        updateUIForAuth();
        if (user) {
          loadPayments();
          loadIncome();
          if (isAdmin) {
            setTodayDate("payments");
            setTodayDate("income");
          }
        }
      });

      function setTodayDate(type) {
        const suffix = type.charAt(0).toUpperCase() + type.slice(1);
        const dateInput = document.getElementById(`date${suffix}`);
        const timeInput = document.getElementById(`time${suffix}`);

        if (dateInput && timeInput) {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, "0");
          const day = String(today.getDate()).padStart(2, "0");
          const hours = String(today.getHours()).padStart(2, "0");
          const minutes = String(today.getMinutes()).padStart(2, "0");

          dateInput.value = `${year}-${month}-${day}`;
          timeInput.value = `${hours}:${minutes}`;
        }
      }

      function updateUIForAuth() {
        const authSection = document.getElementById("authSection");
        const mainContent = document.getElementById("mainContent");
        const paymentFormCard = document.getElementById("paymentFormCard");
        const incomeFormCard = document.getElementById("incomeFormCard");

        if (!currentUser) {
          authSection.style.display = "block";
          mainContent.style.display = "none";
        } else {
          authSection.style.display = "none";
          mainContent.style.display = "block";

          if (paymentFormCard) {
            paymentFormCard.style.display = isAdmin ? "block" : "none";
          }
          if (incomeFormCard) {
            incomeFormCard.style.display = isAdmin ? "block" : "none";
          }

          document.getElementById("userEmail").textContent = currentUser.email;
          document.getElementById("userRole").textContent = isAdmin
            ? "(Administrador)"
            : "(Solo lectura)";
        }
      }

      window.signIn = async function () {
        try {
          await signInWithPopup(auth, provider);
        } catch (error) {
          console.error("Error signing in:", error);
          alert("Error al iniciar sesi√≥n. Por favor intenta de nuevo.");
        }
      };

      window.signOutUser = async function () {
        try {
          await signOut(auth);
        } catch (error) {
          console.error("Error signing out:", error);
          alert("Error al cerrar sesi√≥n.");
        }
      };

      window.refreshData = async function () {
        const btn = document.getElementById("floatingRefresh");
        btn.disabled = true;
        btn.classList.add("refreshing");

        try {
          await loadPayments();
          await loadIncome();

          // Show brief success feedback
          btn.classList.remove("refreshing");
          btn.innerHTML = "‚úì";
          setTimeout(() => {
            btn.innerHTML = "üîÑ";
            btn.disabled = false;
          }, 1000);
        } catch (error) {
          console.error("Error refreshing data:", error);
          alert("Error al actualizar. Por favor intenta de nuevo.");
          btn.classList.remove("refreshing");
          btn.innerHTML = "üîÑ";
          btn.disabled = false;
        }
      };

      window.switchMainTab = function (tab) {
        currentTab = tab;
        document
          .querySelectorAll(".main-tab")
          .forEach((btn) => btn.classList.remove("active"));

        // Find the correct button based on the tab parameter
        const buttons = document.querySelectorAll(".main-tab");
        buttons.forEach((btn) => {
          if (
            (tab === "budget" && btn.onclick.toString().includes("'budget'")) ||
            (tab === "income" && btn.onclick.toString().includes("'income'")) ||
            (tab === "payments" &&
              btn.onclick.toString().includes("'payments'"))
          ) {
            btn.classList.add("active");
          }
        });

        document.getElementById("budgetSection").style.display =
          tab === "budget" ? "block" : "none";
        document.getElementById("paymentsSection").style.display =
          tab === "payments" ? "block" : "none";
        document.getElementById("incomeSection").style.display =
          tab === "income" ? "block" : "none";

        if (tab === "budget") {
          updateBudgetDisplay();
        }
      };

      function formatCurrency(amount) {
        return (
          "$" +
          parseFloat(amount).toLocaleString("es-ES", {
            minimumFractionDigits: 0,
            maximumFractionDigits: 0,
          })
        );
      }

      function updateBudgetDisplay() {
        const totalIncome = income.reduce(
          (sum, item) => sum + parseFloat(item.amount),
          0
        );
        const totalPayments = payments.reduce(
          (sum, item) => sum + parseFloat(item.amount),
          0
        );
        const budget = totalIncome - totalPayments;

        const budgetAmountEl = document.getElementById("budgetAmount");
        budgetAmountEl.textContent = formatCurrency(budget);
        budgetAmountEl.style.color = budget >= 0 ? "#10b981" : "#ff4444";

        document.getElementById("budgetIncome").textContent =
          formatCurrency(totalIncome);
        document.getElementById("budgetPayments").textContent =
          formatCurrency(totalPayments);

        // Find the most recent updatedAt timestamp for income
        let lastIncomeDate = null;
        if (income.length > 0) {
          const incomeTimestamps = income
            .filter((i) => i.updatedAt)
            .map((i) => new Date(i.updatedAt));

          if (incomeTimestamps.length > 0) {
            lastIncomeDate = new Date(Math.max(...incomeTimestamps));
          }
        }

        // Find the most recent updatedAt timestamp for payments
        let lastPaymentDate = null;
        if (payments.length > 0) {
          const paymentTimestamps = payments
            .filter((p) => p.updatedAt)
            .map((p) => new Date(p.updatedAt));

          if (paymentTimestamps.length > 0) {
            lastPaymentDate = new Date(Math.max(...paymentTimestamps));
          }
        }

        // Format and display income update time
        if (lastIncomeDate) {
          const timeStr = lastIncomeDate.toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
          });
          const day = String(lastIncomeDate.getDate()).padStart(2, "0");
          const month = String(lastIncomeDate.getMonth() + 1).padStart(2, "0");
          const year = lastIncomeDate.getFullYear();
          const dateStr = `${day}.${month}.${year}`;
          document.getElementById(
            "lastUpdatedIncome"
          ).textContent = `√öltima actualizaci√≥n de Ingresos: ${dateStr} ${timeStr}`;
        } else {
          document.getElementById("lastUpdatedIncome").textContent =
            "√öltima actualizaci√≥n de Ingresos: --";
        }

        // Format and display payments update time
        if (lastPaymentDate) {
          const timeStr = lastPaymentDate.toLocaleTimeString("es-ES", {
            hour: "2-digit",
            minute: "2-digit",
          });
          const day = String(lastPaymentDate.getDate()).padStart(2, "0");
          const month = String(lastPaymentDate.getMonth() + 1).padStart(2, "0");
          const year = lastPaymentDate.getFullYear();
          const dateStr = `${day}.${month}.${year}`;
          document.getElementById(
            "lastUpdatedPayments"
          ).textContent = `√öltima actualizaci√≥n de Pagos: ${dateStr} ${timeStr}`;
        } else {
          document.getElementById("lastUpdatedPayments").textContent =
            "√öltima actualizaci√≥n de Pagos: --";
        }
      }

      function formatDate(dateStr) {
        let date;

        // Check if it's UTC format (ends with Z)
        if (dateStr.endsWith("Z")) {
          date = new Date(dateStr);
          // Convert to Colombia time (UTC-5)
          date.setHours(date.getHours() - 5);
        } else {
          date = new Date(
            dateStr.includes("T") ? dateStr : dateStr + "T00:00:00"
          );
        }

        const day = String(date.getDate()).padStart(2, "0");
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const year = date.getFullYear();
        const time = dateStr.includes("T")
          ? date.toLocaleTimeString("es-ES", {
              hour: "2-digit",
              minute: "2-digit",
            })
          : "";
        return time
          ? `${day}.${month}.${year} ${time}`
          : `${day}.${month}.${year}`;
      }

      function getFilteredData(type) {
        const data = type === "payments" ? payments : income;
        const currentPeriod =
          type === "payments" ? currentPeriodPayments : currentPeriodIncome;
        const now = new Date();

        if (currentPeriod === "all") return data;

        return data.filter((item) => {
          let itemDate;

          // Handle UTC format
          if (item.createdAt.endsWith("Z")) {
            itemDate = new Date(item.createdAt);
            itemDate.setHours(itemDate.getHours() - 5); // Convert to Colombia time
          } else {
            itemDate = new Date(
              item.createdAt.includes("T")
                ? item.createdAt
                : item.createdAt + "T00:00:00"
            );
          }

          if (currentPeriod === "custom") {
            const fromDate =
              type === "payments"
                ? customDateFromPayments
                : customDateFromIncome;
            const toDate =
              type === "payments" ? customDateToPayments : customDateToIncome;

            if (!fromDate || !toDate) return true;

            const from = new Date(fromDate + "T00:00:00");
            const to = new Date(toDate + "T23:59:59");

            return itemDate >= from && itemDate <= to;
          }

          if (currentPeriod === "today") {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            return itemDate >= today && itemDate < tomorrow;
          }

          if (currentPeriod === "week") {
  // Get the start of the current week (Monday)
  const today = new Date(now);
  today.setHours(0, 0, 0, 0);
  const dayOfWeek = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
  const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // If Sunday, go back 6 days to Monday
  const monday = new Date(today);
  monday.setDate(today.getDate() - daysFromMonday);
  monday.setHours(0, 0, 0, 0);
  return itemDate >= monday;
}

          if (currentPeriod === "month") {
            return (
              itemDate.getMonth() === now.getMonth() &&
              itemDate.getFullYear() === now.getFullYear()
            );
          }

          if (currentPeriod === "year") {
            return itemDate.getFullYear() === now.getFullYear();
          }

          return true;
        });
      }

      function updateSummary(type) {
        const filtered = getFilteredData(type);
        const total = filtered.reduce(
          (sum, item) => sum + parseFloat(item.amount),
          0
        );
        const count = filtered.length;

        const labels = {
          all: "Todo",
          today: "Hoy",
          week: "Esta Semana",
          month: "Este Mes",
          year: "Este A√±o",
          custom: "Personalizado",
        };

        const currentPeriod =
          type === "payments" ? currentPeriodPayments : currentPeriodIncome;
        const label = type === "payments" ? "Total Pagado" : "Total Recibido";

        document.getElementById(
          `periodLabel${type.charAt(0).toUpperCase() + type.slice(1)}`
        ).textContent = `${label} - ${labels[currentPeriod]}`;
        document.getElementById(
          `totalAmount${type.charAt(0).toUpperCase() + type.slice(1)}`
        ).textContent = formatCurrency(total);
        document.getElementById(
          `paymentCount${type.charAt(0).toUpperCase() + type.slice(1)}`
        ).textContent = count;
      }

      window.changeSummaryPeriod = function (period, type) {
        if (type === "payments") {
          currentPeriodPayments = period;
          // Reset custom dates when switching away from custom
          if (period !== "custom") {
            customDateFromPayments = null;
            customDateToPayments = null;
          }
        } else {
          currentPeriodIncome = period;
          // Reset custom dates when switching away from custom
          if (period !== "custom") {
            customDateFromIncome = null;
            customDateToIncome = null;
          }
        }

        const section = document.getElementById(`${type}Section`);
        section
          .querySelectorAll(".tab-btn")
          .forEach((btn) => btn.classList.remove("active"));
        event.target.classList.add("active");

        // Show/hide custom date range inputs
        const customRangeDiv = document.getElementById(
          `customDateRange${type.charAt(0).toUpperCase() + type.slice(1)}`
        );
        if (period === "custom") {
          customRangeDiv.style.display = "block";

          // Set default dates when opening custom range
          const suffix = type.charAt(0).toUpperCase() + type.slice(1);
          const fromInput = document.getElementById(`customFrom${suffix}`);
          const toInput = document.getElementById(`customTo${suffix}`);

          // Set "Desde" to first day of current month
          const today = new Date();
          const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
          const firstDayStr = `${firstDay.getFullYear()}-${String(
            firstDay.getMonth() + 1
          ).padStart(2, "0")}-01`;

          // Set "Hasta" to today
          const todayStr = `${today.getFullYear()}-${String(
            today.getMonth() + 1
          ).padStart(2, "0")}-${String(today.getDate()).padStart(2, "0")}`;

          fromInput.value = firstDayStr;
          toInput.value = todayStr;
        } else {
          customRangeDiv.style.display = "none";
        }

        updateSummary(type);
        renderList(type);
      };

      window.applyCustomRange = function (type) {
        const suffix = type.charAt(0).toUpperCase() + type.slice(1);
        const fromDate = document.getElementById(`customFrom${suffix}`).value;
        const toDate = document.getElementById(`customTo${suffix}`).value;

        if (!fromDate || !toDate) {
          alert("Por favor selecciona ambas fechas (Desde y Hasta)");
          return;
        }

        if (new Date(fromDate) > new Date(toDate)) {
          alert('La fecha "Desde" debe ser anterior a la fecha "Hasta"');
          return;
        }

        if (type === "payments") {
          customDateFromPayments = fromDate;
          customDateToPayments = toDate;
        } else {
          customDateFromIncome = fromDate;
          customDateToIncome = toDate;
        }

        updateSummary(type);
        renderList(type);
      };

      window.sortData = function (type) {
        const sortBy = document.getElementById(
          `sortBy${type.charAt(0).toUpperCase() + type.slice(1)}`
        ).value;
        const data = type === "payments" ? payments : income;

        data.sort((a, b) => {
          switch (sortBy) {
            case "date-desc":
              return new Date(b.createdAt) - new Date(a.createdAt);
            case "date-asc":
              return new Date(a.createdAt) - new Date(b.createdAt);
            case "amount-desc":
              return parseFloat(b.amount) - parseFloat(a.amount);
            case "amount-asc":
              return parseFloat(a.amount) - parseFloat(b.amount);
            case "sender":
              return a.sender.localeCompare(b.sender);
            case "category":
              return (a.category || "").localeCompare(b.category || "");
            default:
              return 0;
          }
        });

        renderList(type);
      };

      window.exportToExcel = function (type) {
        if (typeof XLSX === "undefined") {
          alert("Error: SheetJS library no carg√≥ correctamente.");
          return;
        }
        const filtered = getFilteredData(type);

        if (filtered.length === 0) {
          alert("No hay datos para exportar");
          return;
        }

        const currentPeriod =
          type === "payments" ? currentPeriodPayments : currentPeriodIncome;
        const labels = {
          all: "Todo",
          today: "Hoy",
          week: "Esta Semana",
          month: "Este Mes",
          year: "Este A√±o",
          custom: "Personalizado",
        };
        const total = filtered.reduce(
          (sum, item) => sum + parseFloat(item.amount),
          0
        );
        const title =
          type === "payments" ? "Pagos de Construcci√≥n" : "Ingresos Recibidos";

        const headerRows = [
          [title + " - " + labels[currentPeriod]],
          ["Total", formatCurrency(total)],
          ["Cantidad", filtered.length],
          ["Fecha de Exportaci√≥n:", new Date().toLocaleDateString("es-ES")],
          [],
        ];

        let dataHeaders = [];
        let dataRows = [];
        let amountColumnIndex = -1;

        // Function to wrap text at specified character length
        const wrapText = (text, maxLength) => {
          if (!text || text.length <= maxLength) return text;

          const words = text.split(" ");
          const lines = [];
          let currentLine = "";

          words.forEach((word) => {
            if ((currentLine + word).length <= maxLength) {
              currentLine += (currentLine ? " " : "") + word;
            } else {
              if (currentLine) lines.push(currentLine);
              currentLine = word;
            }
          });

          if (currentLine) lines.push(currentLine);
          return lines.join("\n");
        };

        const toColombiaTime = (dateStr) => {
          let date;
          if (dateStr.endsWith("Z")) {
            date = new Date(dateStr);
            date.setHours(date.getHours() - 5);
          } else {
            date = new Date(
              dateStr.includes("T") ? dateStr : dateStr + "T00:00:00"
            );
          }
          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const year = date.getFullYear();
          const hours = String(date.getHours()).padStart(2, "0");
          const minutes = String(date.getMinutes()).padStart(2, "0");
          return `${day}/${month}/${year} ${hours}:${minutes}`;
        };

        if (type === "payments") {
          dataHeaders = [
            "Fecha",
            "Beneficiario",
            "Concepto",
            "Notas",
            "Categor√≠a", // ‚Üê Moved up
            "√Årea/Lugar", // ‚Üê Moved up
            "Cantidad", // ‚Üê Moved down
            "Unidad", // ‚Üê Moved down
            "Monto",
            "M√©todo",
          ];
          amountColumnIndex = 8; // Monto is still at index 8 (same position)
          filtered.forEach((item) => {
            dataRows.push([
              toColombiaTime(item.createdAt),
              wrapText(item.sender || "", 20),
              wrapText(item.concept || "", 20),
              wrapText(item.notes || "", 25),
              wrapText(item.category || "", 15), // ‚Üê Moved up
              wrapText(item.location || "", 15), // ‚Üê Moved up
              item.quantity ? parseFloat(item.quantity) : null, // ‚Üê Moved down
              item.unit || "", // ‚Üê Moved down
              parseFloat(item.amount),
              item.method || "",
            ]);
          });
        } else {
          dataHeaders = [
            "Fecha",
            "Remitente",
            "Receptor",
            "Concepto",
            "Notas",
            "Monto",
            "M√©todo",
          ];
          amountColumnIndex = 5; // Monto is at index 5
          filtered.forEach((item) => {
            dataRows.push([
              toColombiaTime(item.createdAt),
              wrapText(item.sender || "", 20),
              wrapText(item.receiver || "", 20),
              wrapText(item.concept || "", 20),
              wrapText(item.notes || "", 25),
              parseFloat(item.amount),
              item.method || "",
            ]);
          });
        }

        const wsData = [...headerRows, dataHeaders, ...dataRows];
        const ws = XLSX.utils.aoa_to_sheet(wsData);

        // Apply formatting to cells with proper vertical alignment
        const range = XLSX.utils.decode_range(ws["!ref"]);
        for (let R = range.s.r; R <= range.e.r; ++R) {
          for (let C = range.s.c; C <= range.e.c; ++C) {
            const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
            if (ws[cell_address]) {
              if (!ws[cell_address].s) ws[cell_address].s = {};
              if (!ws[cell_address].s.alignment)
                ws[cell_address].s.alignment = {};

              // Apply number format with thousand separator to amount column (no decimals)
              if (
                R >= 6 &&
                C === amountColumnIndex &&
                typeof ws[cell_address].v === "number"
              ) {
                ws[cell_address].z = "#,##0";
              }

              // Force vertical top alignment for all cells
              ws[cell_address].s.alignment.horizontal = "left";
              ws[cell_address].s.alignment.vertical = "top";
              ws[cell_address].s.alignment.wrapText = true;
            }
          }
        }

        // Set narrow column widths to match wrapped text
        if (type === "payments") {
          ws["!cols"] = [
            { wch: 15 }, // Fecha
            { wch: 18 }, // Beneficiario
            { wch: 18 }, // Concepto
            { wch: 20 }, // Notas
            { wch: 15 }, // Categor√≠a ‚Üê FIXED
            { wch: 15 }, // √Årea/Lugar ‚Üê FIXED
            { wch: 8 }, // Cantidad ‚Üê FIXED
            { wch: 10 }, // Unidad ‚Üê FIXED
            { wch: 12 }, // Monto
            { wch: 12 }, // M√©todo
          ];
        } else {
          ws["!cols"] = [
            { wch: 15 }, // Fecha
            { wch: 18 }, // Remitente
            { wch: 18 }, // Receptor
            { wch: 18 }, // Concepto
            { wch: 20 }, // Notas
            { wch: 12 }, // Monto
            { wch: 12 }, // M√©todo
          ];
        }

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Datos");

        const fileName = `${title.replace(/ /g, "_")}_${
          new Date().toISOString().split("T")[0]
        }.xlsx`;
        XLSX.writeFile(wb, fileName);
      };

      window.printList = function (type) {
        window.print();
      };

      function getDateLabel(dateStr, amount = null) {
        let itemDate;

        // Handle UTC format
        if (dateStr.endsWith("Z")) {
          itemDate = new Date(dateStr);
          itemDate.setHours(itemDate.getHours() - 5); // Convert to Colombia time
        } else {
          itemDate = new Date(
            dateStr.includes("T") ? dateStr : dateStr + "T00:00:00"
          );
        }

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        const itemDateOnly = new Date(itemDate);
        itemDateOnly.setHours(0, 0, 0, 0);

        if (itemDateOnly.getTime() === today.getTime()) {
          return "Hoy";
        } else if (itemDateOnly.getTime() === yesterday.getTime()) {
          return "Ayer";
        } else {
          const day = String(itemDate.getDate()).padStart(2, "0");
          const month = String(itemDate.getMonth() + 1).padStart(2, "0");
          const year = itemDate.getFullYear();
          return `${day}.${month}.${year}`;
        }
      }

      function initSwipeGestures(type) {
        if (window.innerWidth >= 768 || !isAdmin) return;

        const cards = document.querySelectorAll(
          `#paymentsList${
            type.charAt(0).toUpperCase() + type.slice(1)
          } .payment-card`
        );

        cards.forEach((card) => {
          let startX = 0;
          let startY = 0;
          let currentX = 0;
          let currentY = 0;
          let isDragging = false;
          let isHorizontalSwipe = null;

          card.addEventListener(
            "touchstart",
            (e) => {
              // Only allow swiping if card is expanded
              const details = card.querySelector(".payment-card-details");
              if (!details.classList.contains("expanded")) {
                return;
              }

              startX = e.touches[0].clientX;
              startY = e.touches[0].clientY;
              isDragging = false;
              isHorizontalSwipe = null;
              card.style.transition = "none";
            },
            { passive: true }
          );

          card.addEventListener("touchmove", (e) => {
            const details = card.querySelector(".payment-card-details");
            if (!details.classList.contains("expanded")) {
              return;
            }

            currentX = e.touches[0].clientX;
            currentY = e.touches[0].clientY;

            const diffX = Math.abs(startX - currentX);
            const diffY = Math.abs(startY - currentY);

            // Determine swipe direction on first significant movement
            if (isHorizontalSwipe === null && (diffX > 5 || diffY > 5)) {
              isHorizontalSwipe = diffX > diffY;
            }

            // Only proceed if it's a horizontal swipe
            if (isHorizontalSwipe) {
              isDragging = true;
              e.preventDefault(); // Prevent scrolling during horizontal swipe

              const diff = startX - currentX;

              if (diff > 0 && diff < 160) {
                card.style.transform = `translateX(-${diff}px)`;
              } else if (diff < 0) {
                card.style.transform = "translateX(0)";
              }
            }
          });

          card.addEventListener("touchend", () => {
            const details = card.querySelector(".payment-card-details");
            if (!details.classList.contains("expanded") || !isDragging) {
              return;
            }

            isDragging = false;
            isHorizontalSwipe = null;

            card.style.transition = "transform 0.3s ease";
            const diff = startX - currentX;

            if (diff > 80) {
              card.classList.add("swiped");
              card.style.transform = "translateX(-160px)";
            } else {
              card.classList.remove("swiped");
              card.style.transform = "translateX(0)";
            }
          });
        });
      }

      function renderList(type) {
        const container = document.getElementById(
          `paymentsList${type.charAt(0).toUpperCase() + type.slice(1)}`
        );
        const loadingIndicator = document.getElementById(
          `loadingIndicator${type.charAt(0).toUpperCase() + type.slice(1)}`
        );
        const data = getFilteredData(type);

        loadingIndicator.style.display = "none";

        if (data.length === 0) {
          const emptyMsg = type === "payments" ? "pagos" : "ingresos";
          container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No hay ${emptyMsg} todav√≠a. ${
            isAdmin ? "¬°Agrega el primero arriba!" : ""
          }</p>
                    </div>
                `;
          updateSummary(type);
          return;
        }

        // Group data by date
        const groupedData = {};
        data.forEach((item) => {
          const dateLabel = getDateLabel(item.createdAt);
          if (!groupedData[dateLabel]) {
            groupedData[dateLabel] = [];
          }
          groupedData[dateLabel].push(item);
        });

        const isIncome = type === "income";
        let html = "";
        let overallIndex = 0;

        Object.keys(groupedData).forEach((dateLabel) => {
          // Calculate total for this date group
          const dailyTotal = groupedData[dateLabel].reduce(
            (sum, item) => sum + parseFloat(item.amount),
            0
          );

          html += `
        <div class="date-separator">
            <div class="date-separator-line"></div>
            <span class="date-separator-text ${
              isIncome ? "income" : ""
            }">${dateLabel} (${formatCurrency(dailyTotal)})</span>
        </div>
    `;

          groupedData[dateLabel].forEach((item) => {
            overallIndex++;
            let detailsHTML = "";

            if (isIncome) {
              detailsHTML = `
        <div style="padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
            <span style="font-size: 12px; color: #666;">Receptor:</span>
            <span style="font-size: 13px; color: #333; font-weight: 500; margin-left: 4px;">${
              item.receiver
            }</span>
        </div>
        <div style="padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
            <span style="font-size: 12px; color: #666;">Concepto:</span>
            <span style="font-size: 13px; color: #333; font-weight: 500; margin-left: 4px;">${
              item.concept
            }</span>
        </div>
        ${
          item.notes
            ? `
        <div style="padding: 6px 0; border-bottom: 1px solid #f0f0f0;">
            <span style="font-size: 12px; color: #666;">Notas:</span>
            <span style="font-size: 12px; color: #ff4444; font-weight: 500; margin-left: 4px;">${item.notes}</span>
        </div>
        `
            : ""
        }
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 6px 0; font-size: 11px;">
            <div>
                <span style="color: #666;">M√©todo:</span>
                <span style="color: #333; font-weight: 500; margin-left: 4px;">${
                  item.method
                }</span>
            </div>
            <div style="text-align: right;">
                <span style="color: #666;">Fecha:</span>
                <span style="color: #333; font-weight: 500; margin-left: 4px;">${formatDate(
                  item.createdAt
                )}</span>
                ${
                  item.createdBy
                    ? `<br><span style="color: #999; font-size: 10px;">Por: ${item.createdBy}</span>`
                    : ""
                }
                ${
                  item.updatedAt && item.updatedAt !== item.createdAt
                    ? `<br><span style="color: #999; font-size: 10px;">Editado: ${formatDate(
                        item.updatedAt
                      )}</span>`
                    : ""
                }
                ${
                  item.updatedBy
                    ? `<br><span style="color: #999; font-size: 10px;">Por: ${item.updatedBy}</span>`
                    : ""
                }
            </div>
        </div>
    `;
            } else {
              detailsHTML = `
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; padding: 6px 0;">
            <!-- LEFT COLUMN -->
            <div>
                <div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="font-size: 11px; color: #666;">Concepto:</span>
                    <span style="font-size: 11px; color: #333; font-weight: 500; margin-left: 4px;">${
                      item.concept
                    }</span>
                </div>
                
                <div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="font-size: 11px; color: #666;">Cantidad:</span>
                    <span style="font-size: 11px; color: #333; font-weight: 500; margin-left: 4px;">${
                      item.quantity
                        ? item.quantity + " " + (item.unit || "")
                        : "-"
                    }</span>
                </div>
                
                <div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="font-size: 11px; color: #666;">Categor√≠a:</span>
                    <span style="font-size: 11px; color: #333; font-weight: 500; margin-left: 4px;">${
                      item.category
                    }</span>
                </div>
                
                <div style="padding: 4px 0;">
                    <span style="font-size: 11px; color: #666;">√Årea:</span>
                    <span style="font-size: 11px; color: #333; font-weight: 500; margin-left: 4px;">${
                      item.location
                    }</span>
                </div>
            </div>
            
            <!-- RIGHT COLUMN -->
            <div>
                ${
                  item.notes
                    ? `
                <div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="font-size: 11px; color: #666;">Notas:</span>
                    <span style="font-size: 11px; color: #ff4444; font-weight: 500; margin-left: 4px; word-wrap: break-word; display: inline;">${item.notes}</span>
                </div>
            `
                    : ""
                }
                
                <div style="padding: 4px 0; border-bottom: 1px solid #f0f0f0;">
                    <span style="font-size: 11px; color: #666;">M√©todo:</span>
                    <span style="font-size: 11px; color: #333; font-weight: 500; margin-left: 4px;">${
                      item.method
                    }</span>
                </div>
                
                <div style="padding: 4px 0;">
                    <div>
                        <span style="font-size: 11px; color: #666;">Fecha:</span>
                        <span style="font-size: 11px; color: #333; font-weight: 500; margin-left: 4px;">${formatDate(
                          item.createdAt
                        )}</span>
                    </div>
                    ${
                      item.createdBy
                        ? `<div style="color: #999; font-size: 10px; margin-top: 2px;">Por: ${item.createdBy}</div>`
                        : ""
                    }
                    ${
                      item.updatedAt && item.updatedAt !== item.createdAt
                        ? `<div style="color: #999; font-size: 10px; margin-top: 2px;">Editado: ${formatDate(
                            item.updatedAt
                          )}</div>`
                        : ""
                    }
                    ${
                      item.updatedBy
                        ? `<div style="color: #999; font-size: 10px; margin-top: 2px;">Por: ${item.updatedBy}</div>`
                        : ""
                    }
                </div>
            </div>
        </div>
    `;
            }

            html += `
    <div class="payment-card-wrapper">
        ${
          isAdmin
            ? `
        <div class="swipe-actions">
            <div class="swipe-action edit" onclick="event.stopPropagation(); editItem('${item.id}', '${type}')">
                ‚úèÔ∏è<br>Editar
            </div>
            <div class="swipe-action delete" onclick="event.stopPropagation(); deleteItem('${item.id}', '${type}')">
                üóëÔ∏è<br>Eliminar
            </div>
        </div>
        `
            : ""
        }
        <div class="payment-card" onclick="toggleCard(this)">
            <div class="payment-number ${
              isIncome ? "income" : ""
            }">${overallIndex}</div>
            <div class="payment-header">
                <div class="payment-sender">
                    ${item.sender}
                    <span class="payment-card-toggle">‚ñº</span>
                </div>
                <div class="payment-amount ${
                  isIncome ? "income" : ""
                }">${formatCurrency(item.amount)}</div>
            </div>
            <div class="payment-card-details">
                ${detailsHTML}
            </div>
            ${
              isAdmin
                ? `
            <div class="desktop-actions">
                <button class="desktop-action-btn edit" onclick="event.stopPropagation(); editItem('${item.id}', '${type}')">
                    ‚úèÔ∏è Editar
                </button>
                <button class="desktop-action-btn delete" onclick="event.stopPropagation(); deleteItem('${item.id}', '${type}')">
                    üóëÔ∏è Eliminar
                </button>
            </div>
            `
                : ""
            }
        </div>
    </div>
`;
          });
        });

        container.innerHTML = html;

        updateSummary(type);

        if (isAdmin) {
          setTimeout(() => initSwipeGestures(type), 100);
        }
      }

      async function loadPayments() {
        if (!currentUser) return;

        try {
          const q = query(
            collection(db, "payments"),
            orderBy("createdAt", "desc")
          );
          const querySnapshot = await getDocs(q);
          payments = [];
          querySnapshot.forEach((doc) => {
            payments.push({ id: doc.id, ...doc.data() });
          });
          sortData("payments");
          updateBudgetDisplay();
        } catch (error) {
          console.error("Error loading payments:", error);
          document.getElementById("loadingIndicatorPayments").textContent =
            "Error al cargar pagos";
        }
      }

      async function loadIncome() {
        if (!currentUser) return;

        try {
          const q = query(
            collection(db, "income"),
            orderBy("createdAt", "desc")
          );
          const querySnapshot = await getDocs(q);
          income = [];
          querySnapshot.forEach((doc) => {
            income.push({ id: doc.id, ...doc.data() });
          });
          sortData("income");
          updateBudgetDisplay();
        } catch (error) {
          console.error("Error loading income:", error);
          document.getElementById("loadingIndicatorIncome").textContent =
            "Error al cargar ingresos";
        }
      }

      window.editItem = function (id, type) {
        if (!isAdmin) {
          alert("Solo los administradores pueden editar");
          return;
        }

        editingId = id;
        const data = type === "payments" ? payments : income;
        const item = data.find((i) => i.id === id);
        const suffix = type.charAt(0).toUpperCase() + type.slice(1);

        const dateTime = item.createdAt.split("T");
        document.getElementById(`date${suffix}`).value = dateTime[0];
        document.getElementById(`time${suffix}`).value = dateTime[1]
          ? dateTime[1].substring(0, 5)
          : "00:00";
        document.getElementById(`sender${suffix}`).value =
          item.sender;
        if (type === "payments") {
          const conceptSelect = document.getElementById("conceptPayments");
          const conceptOtherDiv = document.getElementById(
            "conceptOtherPayments"
          );
          const conceptOtherInput = document.getElementById(
            "conceptOtherInputPayments"
          );

          // Check if the concept exists in the dropdown
          const optionExists = Array.from(conceptSelect.options).some(
            (opt) => opt.value === item.concept
          );

          if (optionExists) {
            conceptSelect.value = item.concept;
            conceptOtherDiv.style.display = "none";
            conceptOtherInput.required = false;
          } else {
            conceptSelect.value = "otro";
            conceptOtherDiv.style.display = "block";
            conceptOtherInput.value = item.concept;
            conceptOtherInput.required = true;
          }
        } else {
          document.getElementById(`concept${suffix}`).value = item.concept;
        }
        document.getElementById(`amount${suffix}`).value = item.amount;
        document.getElementById(`method${suffix}`).value = item.method;

        if (type === "payments") {
          document.getElementById("notesPayments").value = item.notes || "";
          document.getElementById("quantityPayments").value =
            item.quantity || "";
          document.getElementById("unitPayments").value = item.unit || "";
          document.getElementById("categoryPayments").value = item.category;
          document.getElementById("locationPayments").value = item.location;
        } else {
          document.getElementById("receiverIncome").value = item.receiver;
          document.getElementById("notesIncome").value = item.notes || "";
        }

        const titleElement = document.getElementById(`formTitle${suffix}`);
        titleElement.querySelector("span").textContent =
          type === "payments" ? "Editar Pago" : "Editar Ingreso";
        document.getElementById(`addButton${suffix}`).style.display = "none";
        document.getElementById(`updateButtons${suffix}`).style.display =
          "block";

        // Auto-expand the form if it's collapsed
        const formId = type === "payments" ? "paymentForm" : "incomeForm";
        const form = document.getElementById(formId);
        const arrow = document.getElementById(`formArrow${suffix}`);
        const formCard = document.getElementById(`${type}FormCard`);

        if (form.style.display === "none" || form.style.display === "") {
          form.style.display = "block";
          arrow.textContent = "‚ñ≤";
          formCard.classList.remove("collapsed");
        }

        window.scrollTo({ top: 0, behavior: "smooth" });
      };

      window.cancelEdit = function (type) {
        editingId = null;
        const suffix = type.charAt(0).toUpperCase() + type.slice(1);
        const formId = type === "payments" ? "paymentForm" : "incomeForm";
        const form = document.getElementById(formId);
        if (form) {
          form.reset();
        }
        if (isAdmin) {
          setTodayDate(type);

          // Restart the time interval after canceling edit
          if (type === "payments") {
            if (paymentTimeInterval) clearInterval(paymentTimeInterval);
            paymentTimeInterval = setInterval(() => {
              if (!editingId) {
                setTodayDate("payments");
              }
            }, 1000);
          } else {
            if (incomeTimeInterval) clearInterval(incomeTimeInterval);
            incomeTimeInterval = setInterval(() => {
              if (!editingId) {
                setTodayDate("income");
              }
            }, 1000);
          }
        }
        const titleElement = document.getElementById(`formTitle${suffix}`);
        if (titleElement) {
          const span = titleElement.querySelector("span");
          if (span) {
            span.textContent =
              type === "payments"
                ? "Agregar Nuevo Pago"
                : "Agregar Nuevo Ingreso";
          }
        }
        const addBtn = document.getElementById(`addButton${suffix}`);
        const updateBtns = document.getElementById(`updateButtons${suffix}`);
        if (addBtn) addBtn.style.display = "block";
        if (updateBtns) updateBtns.style.display = "none";
      };

      window.toggleForm = function (type) {
        const formId = type === "payments" ? "paymentForm" : "incomeForm";
        const form = document.getElementById(formId);
        const suffix = type.charAt(0).toUpperCase() + type.slice(1);
        const arrow = document.getElementById(`formArrow${suffix}`);
        const formCardId =
          type === "payments" ? "paymentFormCard" : "incomeFormCard";
        const formCard = document.getElementById(formCardId);

        if (
          form &&
          (form.style.display === "none" || form.style.display === "")
        ) {
          // Expanding
          form.style.display = "block";
          if (arrow) arrow.textContent = "‚ñ≤";
          if (formCard) formCard.classList.remove("collapsed");

          // Only auto-update if not editing
          if (!editingId && isAdmin) {
            setTodayDate(type);

            // Add event listeners to stop auto-update when user manually changes time/date
            const dateInput = document.getElementById(`date${suffix}`);
            const timeInput = document.getElementById(`time${suffix}`);

            const stopAutoUpdate = () => {
              if (type === "payments" && paymentTimeInterval) {
                clearInterval(paymentTimeInterval);
                paymentTimeInterval = null;
              } else if (type === "income" && incomeTimeInterval) {
                clearInterval(incomeTimeInterval);
                incomeTimeInterval = null;
              }
            };

            // Remove old listeners first to avoid duplicates
            dateInput.removeEventListener("input", stopAutoUpdate);
            timeInput.removeEventListener("input", stopAutoUpdate);
            dateInput.removeEventListener("change", stopAutoUpdate);
            timeInput.removeEventListener("change", stopAutoUpdate);

            // Add new listeners
            dateInput.addEventListener("input", stopAutoUpdate, { once: true });
            timeInput.addEventListener("input", stopAutoUpdate, { once: true });
            dateInput.addEventListener("change", stopAutoUpdate, {
              once: true,
            });
            timeInput.addEventListener("change", stopAutoUpdate, {
              once: true,
            });

            // Start updating time every second while form is open
            if (type === "payments") {
              if (paymentTimeInterval) clearInterval(paymentTimeInterval);
              paymentTimeInterval = setInterval(() => {
                if (!editingId) {
                  setTodayDate("payments");
                }
              }, 1000);
            } else {
              if (incomeTimeInterval) clearInterval(incomeTimeInterval);
              incomeTimeInterval = setInterval(() => {
                if (!editingId) {
                  setTodayDate("income");
                }
              }, 1000);
            }
          }
        } else {
          // Collapsing
          if (form) form.style.display = "none";
          if (arrow) arrow.textContent = "‚ñº";
          if (formCard) formCard.classList.add("collapsed");

          // Clear the interval when form is collapsed
          if (type === "payments" && paymentTimeInterval) {
            clearInterval(paymentTimeInterval);
            paymentTimeInterval = null;
          } else if (type === "income" && incomeTimeInterval) {
            clearInterval(incomeTimeInterval);
            incomeTimeInterval = null;
          }
        }
      };
      // Mapping of concepts to categories and areas
      const conceptMapping = {
        "Mano de obra d√≠a": { category: "Construcci√≥n", area: "" },
        "Materiales de construcci√≥n": { category: "Materiales", area: "" },
        "Materiales de acabados": { category: "Materiales", area: "" },
        "Materiales de carpinter√≠a": { category: "Materiales", area: "" },
        "Materiales el√©ctricos": {
          category: "Instalaciones",
          area: "Instalaci√≥n el√©ctrica",
        },
        "Materiales sanitarios": {
          category: "Instalaciones",
          area: "Instalaci√≥n sanitaria",
        },
        "Flete/Transporte": { category: "Log√≠stica", area: "General" },
        "Alquiler de equipos": { category: "Equipos", area: "General" },
        otro: { category: "", area: "" },
      };

      window.handleConceptChange = function () {
        const conceptSelect = document.getElementById("conceptPayments");
        const conceptOtherDiv = document.getElementById("conceptOtherPayments");
        const conceptOtherInput = document.getElementById(
          "conceptOtherInputPayments"
        );
        const categorySelect = document.getElementById("categoryPayments");
        const locationSelect = document.getElementById("locationPayments");

        const selectedConcept = conceptSelect.value;

        // Handle "Otro" option
        if (selectedConcept === "otro") {
          conceptOtherDiv.style.display = "block";
          conceptOtherInput.required = true;
          categorySelect.value = "";
          locationSelect.value = "";
        } else {
          conceptOtherDiv.style.display = "none";
          conceptOtherInput.required = false;
          conceptOtherInput.value = "";

          // Auto-fill category and area based on mapping
          if (conceptMapping[selectedConcept]) {
            const mapping = conceptMapping[selectedConcept];
            categorySelect.value = mapping.category;
            locationSelect.value = mapping.area;
          }
        }
      };

      document
        .getElementById("paymentForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          if (!isAdmin) {
            alert("Solo los administradores pueden agregar o editar");
            return;
          }

          const submitBtn = editingId
            ? document.querySelector(
                '#updateButtonsPayments button[type="submit"]'
              )
            : document.getElementById("addButtonPayments");

          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = "Guardando...";

          // Stop auto-update interval before saving
          if (paymentTimeInterval) {
            clearInterval(paymentTimeInterval);
            paymentTimeInterval = null;
          }

          const paymentData = {
            createdAt:
              document.getElementById("datePayments").value +
              "T" +
              document.getElementById("timePayments").value,
            sender: document.getElementById("senderPayments").value,
            concept:
              document.getElementById("conceptPayments").value === "otro"
                ? document.getElementById("conceptOtherInputPayments").value
                : document.getElementById("conceptPayments").value,
            notes: document.getElementById("notesPayments").value || null,
            quantity: document.getElementById("quantityPayments").value || null,
            unit: document.getElementById("unitPayments").value || null,
            category: document.getElementById("categoryPayments").value,
            location: document.getElementById("locationPayments").value,
            amount: document.getElementById("amountPayments").value,
            method: document.getElementById("methodPayments").value,
          };

          if (editingId) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            const day = String(now.getDate()).padStart(2, "0");
            const hours = String(now.getHours()).padStart(2, "0");
            const minutes = String(now.getMinutes()).padStart(2, "0");
            paymentData.updatedAt = `${year}-${month}-${day}T${hours}:${minutes}`;
            paymentData.updatedBy = currentUser.email;
          } else {
            paymentData.createdBy = currentUser.email;
          }

          try {
            if (editingId) {
              await updateDoc(doc(db, "payments", editingId), paymentData);
              window.cancelEdit("payments");
            } else {
              await addDoc(collection(db, "payments"), paymentData);
              this.reset();
              setTodayDate("payments");
            }

            await loadPayments();
            window.scrollTo({ top: 0, behavior: "smooth" });
          } catch (error) {
            console.error("Error saving payment:", error);
            alert("Error al guardar. Por favor intenta de nuevo.");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });

      document
        .getElementById("incomeForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          if (!isAdmin) {
            alert("Solo los administradores pueden agregar o editar");
            return;
          }

          const submitBtn = editingId
            ? document.querySelector(
                '#updateButtonsIncome button[type="submit"]'
              )
            : document.getElementById("addButtonIncome");

          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = "Guardando...";

          // Stop auto-update interval before saving
          if (incomeTimeInterval) {
            clearInterval(incomeTimeInterval);
            incomeTimeInterval = null;
          }

          const incomeData = {
            createdAt:
              document.getElementById("dateIncome").value +
              "T" +
              document.getElementById("timeIncome").value,
            sender: document.getElementById("senderIncome").value,
            receiver: document.getElementById("receiverIncome").value,
            concept: document.getElementById("conceptIncome").value,
            notes: document.getElementById("notesIncome").value || null,
            amount: document.getElementById("amountIncome").value,
            method: document.getElementById("methodIncome").value,
          };

          if (editingId) {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, "0");
            const day = String(now.getDate()).padStart(2, "0");
            const hours = String(now.getHours()).padStart(2, "0");
            const minutes = String(now.getMinutes()).padStart(2, "0");
            incomeData.updatedAt = `${year}-${month}-${day}T${hours}:${minutes}`;
            incomeData.updatedBy = currentUser.email;
          } else {
            incomeData.createdBy = currentUser.email;
          }

          try {
            if (editingId) {
              await updateDoc(doc(db, "income", editingId), incomeData);
              window.cancelEdit("income");
            } else {
              await addDoc(collection(db, "income"), incomeData);
              this.reset();
              setTodayDate("income");
            }

            await loadIncome();
            window.scrollTo({ top: 0, behavior: "smooth" });
          } catch (error) {
            console.error("Error saving income:", error);
            alert("Error al guardar. Por favor intenta de nuevo.");
          } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });

      window.deleteItem = async function (id, type) {
        if (!isAdmin) {
          alert("Solo los administradores pueden eliminar");
          return;
        }

        const itemType = type === "payments" ? "pago" : "ingreso";
        if (
          confirm(`¬øEst√°s seguro de que quieres eliminar este ${itemType}?`)
        ) {
          try {
            await deleteDoc(doc(db, type, id));
            if (type === "payments") {
              await loadPayments();
            } else {
              await loadIncome();
            }
          } catch (error) {
            console.error("Error deleting:", error);
            alert("Error al eliminar. Por favor intenta de nuevo.");
          }
        }
      };
      window.toggleCard = function (card) {
        const details = card.querySelector(".payment-card-details");
        const toggle = card.querySelector(".payment-card-toggle");

        details.classList.toggle("expanded");
        toggle.classList.toggle("expanded");
      };

      // Help examples for each concept
      const helpExamples = {
        "Mano de obra d√≠a": [
          "üë∑ FUNDACI√ìN:",
          "‚Ä¢ 8 horas excavaci√≥n manual para fundaci√≥n, 3 trabajadores",
          "‚Ä¢ 2 alba√±iles fundaci√≥n, 10 horas, vigas de fundaci√≥n",
          "‚Ä¢ 1 oficial nivelaci√≥n y compactaci√≥n, 6 horas",
          "‚Ä¢ 3 ayudantes limpieza de excavaci√≥n, d√≠a completo",
          "‚Ä¢ 1 maestro replanteo y trazado de ejes, 4 horas",
          "‚Ä¢ Excavaci√≥n con retroexcavadora, 5 horas operador",
          "‚Ä¢ Excavaci√≥n tanque s√©ptico finca, 3 trabajadores, 2 d√≠as", // ‚Üê NUEVO
          "‚Ä¢ Construcci√≥n pozo s√©ptico 2m, 2 alba√±iles, 8 horas", // ‚Üê NUEVO
          "‚Ä¢ Nivelaci√≥n terreno acceso finca, 2 operarios, d√≠a completo", // ‚Üê NUEVO
          "",
          "üë∑ ESTRUCTURA:",
          "‚Ä¢ 2 alba√±iles fundici√≥n de columnas piso 1, 8 horas",
          "‚Ä¢ 1 oficial armado de hierro columnas, d√≠a completo",
          "‚Ä¢ 2 ayudantes preparaci√≥n de concreto, 10 horas",
          "‚Ä¢ 1 maestro carpinter√≠a para formaletas, 8 horas",
          "‚Ä¢ Vibrado de concreto en 6 columnas, 3 horas",
          "‚Ä¢ 3 alba√±iles fundici√≥n de vigas piso 2, d√≠a completo",
          "‚Ä¢ Desencofrado de columnas, 2 trabajadores, 4 horas",
          "‚Ä¢ Fundici√≥n placa entrepiso 1-2, 4 trabajadores, 10 horas", // ‚Üê NUEVO
          "‚Ä¢ Fundici√≥n escalera concreto a piso 2, 3 trabajadores, d√≠a completo", // ‚Üê NUEVO
          "",
          "üë∑ MAMPOSTER√çA:",
          "‚Ä¢ 2 alba√±iles levantamiento de muros 1er piso, 8 horas",
          "‚Ä¢ 1 oficial pegada de bloques #5, d√≠a completo",
          "‚Ä¢ 3 ayudantes transporte de materiales, 8 horas",
          "‚Ä¢ Pa√±ete exterior fachada principal, 2 oficiales, 10 horas",
          "‚Ä¢ Pa√±ete interior habitaciones, 1 alba√±il, d√≠a completo",
          "‚Ä¢ Levantamiento muro perimetral, 4 trabajadores, 8 horas",
          "",
          "üë∑ INSTALACIONES:",
          "‚Ä¢ 1 maestro electricista instalaci√≥n completa casa, 8 horas",
          "‚Ä¢ 2 oficiales cableado y ductos el√©ctricos, d√≠a completo",
          "‚Ä¢ 1 maestro plomero instalaci√≥n sanitaria, 10 horas",
          "‚Ä¢ 1 oficial instalaci√≥n tuber√≠as agua piso 1, 8 horas",
          "‚Ä¢ 2 ayudantes excavaci√≥n zanjas para tuber√≠as, 6 horas",
          "‚Ä¢ Instalaci√≥n de caja de breakers, electricista, 3 horas",
          "‚Ä¢ Prueba hidr√°ulica tuber√≠as, plomero, 2 horas",
          "",
          "üë∑ ACABADOS:",
          "‚Ä¢ 1 enchapador cer√°mica ba√±o principal, d√≠a completo",
          "‚Ä¢ 2 pintores estuco interior sala/comedor, 8 horas",
          "‚Ä¢ 1 pintor fachada exterior, 10 horas",
          "‚Ä¢ 1 carpintero instalaci√≥n 3 puertas, 6 horas",
          "‚Ä¢ Instalaci√≥n cielo raso cocina, 2 trabajadores, 8 horas",
          "‚Ä¢ Colocaci√≥n piso cer√°mica habitaci√≥n, 1 maestro, d√≠a completo",
          "‚Ä¢ Enchape de cocina completo, 2 trabajadores, 2 d√≠as",
          "‚Ä¢ Pintura vin√≠lica 2 habitaciones, 1 pintor, 8 horas",
          "",
          "üë∑ OTROS:",
          "‚Ä¢ 1 soldador estructura met√°lica escaleras, 5 horas",
          "‚Ä¢ Impermeabilizaci√≥n terraza, 1 maestro, d√≠a completo",
          "‚Ä¢ Jardiner√≠a y siembra c√©sped, 2 trabajadores, 8 horas",
          "‚Ä¢ Limpieza general de obra, 3 ayudantes, 6 horas",
          "‚Ä¢ Instalaci√≥n tanque de agua, 2 oficiales, 4 horas",
          "‚Ä¢ Limpieza y desmonte vegetaci√≥n finca, 4 trabajadores, 2 d√≠as", // ‚Üê NUEVO
          "‚Ä¢ Instalaci√≥n sistema drenaje terreno, 1 maestro, d√≠a completo", // ‚Üê NUEVO
        ],
        "Materiales de construcci√≥n": [
          "üèóÔ∏è FUNDACI√ìN:",
          "‚Ä¢ 20 sacos cemento gris x 50kg para fundaci√≥n",
          "‚Ä¢ 4 m¬≥ arena lavada, mezcla de cimientos",
          '‚Ä¢ 3 m¬≥ grava 3/4", concreto columnas',
          "‚Ä¢ 2 m¬≥ piedra para base fundaci√≥n",
          "‚Ä¢ 15 varillas #4 corrugadas de 6m, columnas piso 1",
          "‚Ä¢ 10 kg alambre negro #18 para amarre",
          "‚Ä¢ 8 m¬≥ material relleno para compactaci√≥n", // ‚Üê MODIFICADO (sin "s√≥tano")
          "‚Ä¢ 30 sacos cemento para fundici√≥n 8 columnas",
          "‚Ä¢ 5 m¬≥ grava para drenajes y caminos finca", // ‚Üê NUEVO
          "‚Ä¢ 50 m¬≤ geotextil para sistema de drenaje", // ‚Üê NUEVO
          "",
          "üß± MAMPOSTER√çA:",
          "‚Ä¢ 200 bloques #5 (12x20x40cm) para muros habitaciones",
          "‚Ä¢ 150 bloques #6 para muro perimetral",
          "‚Ä¢ 500 ladrillos tolete #5 para fachada",
          "‚Ä¢ 15 sacos mortero pre-mezclado pegado de bloque",
          "‚Ä¢ 300 bloques #4 para divisiones interiores",
          "‚Ä¢ 10 sacos cemento gris para pa√±ete",
          "",
          "ü™µ ESTRUCTURA Y FORMALETA:",
          "‚Ä¢ 40 tablas pino 1x12x3.5m para formaletas columnas",
          "‚Ä¢ 6 planchas triplex 15mm reutilizable",
          "‚Ä¢ 20 alfaj√≠as y 15 puntales met√°licos alquiler",
          '‚Ä¢ 5 kg clavos 3" para armar formaletas',
          "‚Ä¢ 100 amarres pl√°sticos para asegurar formaleta",
          "‚Ä¢ 25 tablas para formaleta vigas techo",
          "",
          "üî© ACERO Y COMPLEMENTOS:",
          "‚Ä¢ 50 m¬≤ malla electrosoldada 15x15cm piso",
          "‚Ä¢ 30 m malla eslabonada cerramiento posterior",
          '‚Ä¢ 8 perfiles √°ngulo 2"x2" estructura met√°lica',
          '‚Ä¢ 10 platinas 1/4" x 2" refuerzo',
          "‚Ä¢ 2 kg electrodos 6013 para soldadura",
          "‚Ä¢ 30 postes madera inmunizada 3m cerco finca", // ‚Üê NUEVO
          "‚Ä¢ 100m alambre p√∫a calibre 12.5 cerramiento", // ‚Üê NUEVO
          "",
          "üíß IMPERMEABILIZACI√ìN:",
          "‚Ä¢ 4 galones impermeabilizante l√≠quido terraza",
          "‚Ä¢ 20 m¬≤ membrana asf√°ltica muros de contenci√≥n", // ‚Üê MODIFICADO (sin "s√≥tano")
          "‚Ä¢ 10 litros pintura bituminosa anti-humedad",
          "‚Ä¢ 15 m¬≤ manto asf√°ltico techo principal",
        ],
        "Materiales de acabados": [
          "üé® PINTURA:",
          "‚Ä¢ 6 galones pintura vin√≠lica lavable blanca interior",
          "‚Ä¢ 4 galones acr√≠lica beige claro fachada exterior",
          "‚Ä¢ 2 galones esmalte blanco para puertas/ventanas",
          "‚Ä¢ 8 sacos estuco en polvo (25kg) paredes interiores",
          "‚Ä¢ 5 sacos estuco gris exteriores",
          "‚Ä¢ 3 galones sellador paredes nuevas",
          "‚Ä¢ 1 gal√≥n anticorrosivo gris para rejas",
          "‚Ä¢ 2 galones thinner limpieza brochas",
          "‚Ä¢ 10 galones vin√≠lica color marfil habitaciones",
          "",
          "üî≤ PISOS Y ENCHAPES:",
          "‚Ä¢ 35 m¬≤ cer√°mica 45x45cm color beige sala/comedor",
          "‚Ä¢ 18 m¬≤ porcelanato 60x60cm gris habitaciones",
          "‚Ä¢ 12 m¬≤ cer√°mica 30x45cm blanca ba√±os",
          "‚Ä¢ 8 m¬≤ enchape tipo piedra gris fachada entrada",
          "‚Ä¢ 25 m¬≤ piso laminado imitaci√≥n madera habitaciones",
          "‚Ä¢ 40 metros lineales guardaescobas cer√°mica blanco",
          "‚Ä¢ 15 metros z√≥calos madera color nogal",
          "",
          "üîß ADHESIVOS Y PEGANTES:",
          "‚Ä¢ 10 sacos pegamento para cer√°mica (25kg)",
          "‚Ä¢ 3 kg pegante Boxer para enchapes livianos",
          "‚Ä¢ 4 galones adhesivo piso vin√≠lico",
          "‚Ä¢ 8 kg frag√ºe gris para pisos",
          "‚Ä¢ 5 kg frag√ºe blanco para ba√±os",
          "‚Ä¢ 2 kg frag√ºe ep√≥xico juntas cocina",
          "‚Ä¢ 12 tubos silicona transparente acabados",
          "",
          "üö™ COMPLEMENTOS:",
          "‚Ä¢ 30 metros molduras MDF blancas techo sala",
          "‚Ä¢ 20 metros cornisas decorativas yeso",
          "‚Ä¢ 3 rieles cortinas 2.5m aluminio",
          "‚Ä¢ 2 barras decorativas 3m madera",
        ],
        "Materiales de carpinter√≠a": [
          "üö™ PUERTAS:",
          "‚Ä¢ 1 puerta principal madera s√≥lida 90x210cm seguridad",
          "‚Ä¢ 4 puertas interiores MDF 70x200cm blancas",
          "‚Ä¢ 2 puertas 80x200cm para habitaciones principales",
          "‚Ä¢ 1 puerta tambor 60x200cm ba√±o auxiliar",
          "‚Ä¢ 1 puerta aluminio vidrio 90x210cm patio",
          "‚Ä¢ 5 marcos madera 70cm para puertas internas",
          "‚Ä¢ 3 marcos 90cm color caoba",
          "",
          "ü™ü VENTANAS:",
          "‚Ä¢ 3 ventanas aluminio blanco corredizas 120x100cm",
          "‚Ä¢ 2 ventanas PVC vidrio 100x80cm habitaciones",
          "‚Ä¢ 1 ventana madera guillotina 80x120cm cocina",
          "‚Ä¢ 4 celos√≠as aluminio 60x40cm ba√±os",
          "‚Ä¢ 15 m¬≤ vidrio claro 4mm para ventanas",
          "‚Ä¢ 3 m¬≤ vidrio templado 6mm divisiones ba√±o",
          "",
          "üóÑÔ∏è MUEBLES:",
          "‚Ä¢ 1 closet modular melamina blanca 3 puertas 2.4m",
          "‚Ä¢ Mueble cocina superior 6 puertas 3m lineal",
          "‚Ä¢ Mueble cocina inferior 4 cajones 2.5m",
          "‚Ä¢ 2 gabinetes ba√±o con espejo 60x50cm",
          "‚Ä¢ 4 repisas flotantes 80cm blancas",
          "‚Ä¢ 3 planchas MDF 18mm (2.44x1.22m)",
          "‚Ä¢ 2 planchas melamina wengu√©",
          "",
          "üî© HERRAJES:",
          '‚Ä¢ 15 pares bisagras libro 3" acero',
          "‚Ä¢ 20 bisagras cazoleta para closet",
          "‚Ä¢ 4 cerraduras pomo para habitaciones",
          "‚Ä¢ 1 cerradura seguridad 3 puntos puerta principal",
          "‚Ä¢ 6 picaportes ba√±o dorados",
          "‚Ä¢ 12 pares rieles cajones telesc√≥picos 40cm",
          "‚Ä¢ 2 juegos correderas puertas closet 2.4m",
          "‚Ä¢ 8 tiradores acero inox 12cm cocina",
        ],
        "Materiales el√©ctricos": [
          "‚ö° CABLES Y CONDUCTORES:",
          "‚Ä¢ 50m cable THHN #8 rojo acometida principal",
          "‚Ä¢ 80m cable THHN #10 negro circuito cocina/calentador",
          "‚Ä¢ 120m cable THHN #12 azul tomas generales",
          "‚Ä¢ 150m cable THHN #14 blanco iluminaci√≥n",
          "‚Ä¢ 100m cable gemelo 2x14 exteriores garaje",
          "‚Ä¢ 80m cable coaxial RG6 TV habitaciones",
          "‚Ä¢ 100m cable UTP Cat 6 red internet completa",
          "",
          "üîå INTERRUPTORES Y TOMAS:",
          "‚Ä¢ 12 interruptores sencillos blancos",
          "‚Ä¢ 4 interruptores dobles sala/comedor",
          "‚Ä¢ 3 interruptores conmutados 3 v√≠as escaleras",
          "‚Ä¢ 15 tomacorrientes dobles polarizados",
          "‚Ä¢ 8 tomacorrientes polo a tierra ba√±os/cocina",
          "‚Ä¢ 1 toma especial 220V 30A para estufa",
          "‚Ä¢ 2 dimmers atenuador luces habitaciones",
          "‚Ä¢ 3 tomas USB integradas habitaciones",
          "",
          "üì¶ CAJAS Y PROTECCIONES:",
          "‚Ä¢ 1 caja breakers 18 circuitos marca Schneider",
          "‚Ä¢ 8 breakers monopolares 20A iluminaci√≥n/tomas",
          "‚Ä¢ 2 breakers bipolares 30A estufa/calentador 220V",
          "‚Ä¢ 2 breakers GFCI 20A ba√±os",
          "‚Ä¢ 1 breaker totalizador 60A principal",
          "‚Ä¢ 20 cajas el√©ctricas rectangulares 2x4",
          "‚Ä¢ 8 cajas octogonales para l√°mparas techo",
          "‚Ä¢ 100 tacos y tornillos #8 montaje",
          "",
          "üîß TUBER√çA Y ACCESORIOS:",
          '‚Ä¢ 80m tuber√≠a conduit PVC 1/2" naranja',
          '‚Ä¢ 50m tuber√≠a conduit 3/4" circuitos principales',
          '‚Ä¢ 40 codos 90¬∞ PVC 1/2"',
          '‚Ä¢ 20 uniones PVC 1/2"',
          '‚Ä¢ 50 abrazaderas tipo omega 1/2"',
          "‚Ä¢ 10 rollos cinta aislante 3M negra",
          "‚Ä¢ 3 rollos cinta roja/azul/verde identificaci√≥n fases",
          "",
          "üí° ILUMINACI√ìN:",
          "‚Ä¢ 12 l√°mparas LED downlight 12W empotrar techo",
          "‚Ä¢ 6 l√°mparas LED tubulares 18W 60cm cocina/ba√±o",
          "‚Ä¢ 15 bombillas LED A60 9W blanco c√°lido",
          "‚Ä¢ 2 reflectores LED 50W exteriores fachada/patio",
          "‚Ä¢ 4 apliques decorativos pared habitaciones",
          "‚Ä¢ 8 portal√°mparas E27 bakelita",
          "‚Ä¢ 10m tira LED RGB con control cocina",
        ],
        "Materiales sanitarios": [
          "üíß TUBER√çA SANITARIA (DESAG√úE):",
          '‚Ä¢ 15m tuber√≠a PVC sanitaria 2" lavamanos',
          '‚Ä¢ 25m tuber√≠a PVC sanitaria 3" desag√ºes generales',
          '‚Ä¢ 20m tuber√≠a PVC sanitaria 4" sanitarios',
          '‚Ä¢ 10m tuber√≠a PVC sanitaria 6" bajante principal',
          '‚Ä¢ 12 codos 90¬∞ sanitarios 3"',
          "‚Ä¢ 6 codos 45¬∞ cambio direcci√≥n",
          '‚Ä¢ 8 yees/tees 3" ramificaciones ba√±os',
          "‚Ä¢ 4 sifones PVC lavamanos",
          '‚Ä¢ 3 tapones registro con tapa 4"',
          "",
          "üö∞ TUBER√çA PRESI√ìN (AGUA POTABLE):",
          '‚Ä¢ 60m tuber√≠a PVC presi√≥n 1/2" ramales',
          '‚Ä¢ 30m tuber√≠a PVC presi√≥n 3/4" l√≠nea principal',
          '‚Ä¢ 10m tuber√≠a PVC presi√≥n 1" acometida',
          '‚Ä¢ 20 codos 90¬∞ presi√≥n 1/2"',
          '‚Ä¢ 15 tees presi√≥n 1/2" para derivaciones',
          "‚Ä¢ 10 uniones adaptadores macho/hembra",
          '‚Ä¢ 8 reducciones 3/4" a 1/2"',
          "‚Ä¢ 6 tapones presi√≥n varios",
          "",
          "üîß V√ÅLVULAS Y CONTROLES:",
          '‚Ä¢ 8 v√°lvulas paso 1/2" tipo bola',
          '‚Ä¢ 2 v√°lvulas compuerta 3/4" principal',
          "‚Ä¢ 4 llaves paso angulares lavamanos cromadas",
          '‚Ä¢ 2 v√°lvulas check 3/4" anti-retorno',
          "‚Ä¢ 2 flotadores tanques agua",
          '‚Ä¢ 3 llaves nariz 1/2" jard√≠n',
          "",
          "üöΩ APARATOS SANITARIOS:",
          "‚Ä¢ 2 sanitarios tanque dual flush blanco",
          "‚Ä¢ 1 sanitario one-piece elongado ba√±o principal",
          "‚Ä¢ 2 lavamanos pedestal 50cm blanco",
          "‚Ä¢ 1 lavamanos sobre-poner 40cm con mueble",
          "‚Ä¢ 1 lavaplatos acero inox 2 pozos 80x50cm",
          "‚Ä¢ 1 lavadero cemento 60x50cm patio",
          "‚Ä¢ 2 duchas tipo lluvia cromadas 25cm",
          "",
          "üöø GRIFER√çA:",
          "‚Ä¢ 2 grifer√≠as lavamanos monocontrol cromadas",
          "‚Ä¢ 2 grifer√≠as ducha mezclador temperatura",
          "‚Ä¢ 1 grifer√≠a cocina cuello cisne giratorio",
          "‚Ä¢ 1 mezcladora termost√°tica ducha principal",
          "‚Ä¢ 2 juegos ducha completo (regadera + manguera)",
          "",
          "üí¶ TANQUES Y BOMBAS:",
          "‚Ä¢ 1 tanque agua elevado 1000L polietileno",
          "‚Ä¢ 1 tanque subterr√°neo 2000L cisterna",
          "‚Ä¢ 1 bomba perif√©rica 1HP Pedrollo",
          "‚Ä¢ 1 bomba achique 1/2HP para fundaci√≥n", // ‚Üê MODIFICADO (sin "s√≥tano")
          "‚Ä¢ 1 tanque hidro-neum√°tico 24L presi√≥n constante",
          "‚Ä¢ 1 tanque s√©ptico prefabricado 1500L finca", // ‚Üê NUEVO
          "‚Ä¢ 2 anillos concreto pozo s√©ptico 1m di√°metro", // ‚Üê NUEVO
          "‚Ä¢ 1 tapa registro pozo s√©ptico hierro fundido", // ‚Üê NUEVO
          '‚Ä¢ 20m tuber√≠a PVC 4" desag√ºe a pozo s√©ptico', // ‚Üê NUEVO
          "",
          "üß∞ ACCESORIOS:",
          "‚Ä¢ 2 frascos pegante PVC presi√≥n 240ml",
          "‚Ä¢ 1 frasco pegante sanitario 500ml",
          "‚Ä¢ 1 frasco limpiador PVC",
          "‚Ä¢ 3 rollos tefl√≥n cinta para roscas",
          "‚Ä¢ 3 desag√ºes cromados lavamanos",
          "‚Ä¢ 2 sifones flexibles lavaplatos",
          "‚Ä¢ 4 rejillas piso acero inox 10x10cm ba√±os",
        ],
        "Flete/Transporte": [
          "üöõ TRANSPORTE DE MATERIALES:",
          "‚Ä¢ Flete 200 bloques + 20 sacos cemento desde ferreter√≠a",
          "‚Ä¢ Transporte 1 viaje volqueta arena/grava 6 m¬≥",
          "‚Ä¢ Viaje cami√≥n 30 varillas hierro #4 de 6m",
          "‚Ä¢ Flete materiales el√©ctricos completos casa (cables, breakers)",
          "‚Ä¢ Transporte 40 m¬≤ cer√°mica + pegamentos desde bodega",
          "‚Ä¢ Viaje 3 puertas + 4 ventanas desde carpinter√≠a",
          "‚Ä¢ Transporte materiales camino destapado finca, viaje especial", // ‚Üê NUEVO
          "‚Ä¢ Flete 4x4 materiales pesados acceso dif√≠cil finca", // ‚Üê NUEVO
          "",
          "üèóÔ∏è TRANSPORTE DE EQUIPOS:",
          "‚Ä¢ Flete mezcladora concreto ida y vuelta",
          "‚Ä¢ Transporte 20 cuerpos andamios met√°licos",
          "‚Ä¢ Viaje retroexcavadora en cama baja",
          "‚Ä¢ Flete compresor + herramientas pintura",
          "",
          "‚ôªÔ∏è RETIRO DE ESCOMBROS:",
          "‚Ä¢ 2 viajes volqueta escombros a botadero (8 m¬≥)",
          "‚Ä¢ Transporte tierra excavaci√≥n fundaci√≥n 15 m¬≥",
          "‚Ä¢ Retiro chatarra met√°lica y desperdicios obra",
          "‚Ä¢ Viaje limpieza sobrantes acabados",
          "",
          "üì¶ OTROS:",
          "‚Ä¢ Alquiler cami√≥n mudanza mezcladora + andamios",
          "‚Ä¢ Taxi carga compras urgentes sanitarios",
          "‚Ä¢ Domicilio express 5 sacos cemento faltantes",
          "‚Ä¢ Flete devoluci√≥n materiales sobrantes ferreter√≠a",
        ],
        "Alquiler de equipos": [
          "üî® EQUIPOS DE CONSTRUCCI√ìN:",
          "‚Ä¢ Mezcladora concreto 2 sacos, 3 d√≠as alquiler",
          "‚Ä¢ Vibrador concreto el√©ctrico, 2 d√≠as fundici√≥n columnas",
          '‚Ä¢ Cortadora disco 14" concreto, 1 semana',
          '‚Ä¢ Pulidora 7" con 5 discos corte, 4 d√≠as',
          "‚Ä¢ Rotomartillo SDS potente, 1 semana instalaciones",
          "‚Ä¢ Martillo demoledor el√©ctrico, 2 d√≠as romper pisos",
          "‚Ä¢ Compactadora bailarina, 3 d√≠as compactaci√≥n relleno",
          "",
          "‚öôÔ∏è EQUIPOS EL√âCTRICOS:",
          "‚Ä¢ Planta el√©ctrica 5KW, 1 mes obra sin luz",
          "‚Ä¢ Planta el√©ctrica 10KW finca sin energ√≠a, 3 meses", // ‚Üê NUEVO (opci√≥n m√°s grande)
          "‚Ä¢ Compresor aire 25L pintura, 1 semana acabados",
          "‚Ä¢ Pistola pintar el√©ctrica, 3 d√≠as fachada",
          "‚Ä¢ Hidrolavadora 1500PSI limpieza final, 2 d√≠as",
          "",
          "üìê MEDICI√ìN Y NIVELACI√ìN:",
          "‚Ä¢ Nivel l√°ser autonivelante, 1 semana replanteo",
          "‚Ä¢ Teodolito b√°sico trazado ejes, 3 d√≠as",
          "‚Ä¢ Distanci√≥metro l√°ser mediciones, 2 d√≠as",
          "",
          "ü™ú ACCESO Y SEGURIDAD:",
          "‚Ä¢ 15 cuerpos andamios met√°licos, 2 meses obra completa",
          "‚Ä¢ Andamio aluminio plegable 6m, 1 semana fachada",
          "‚Ä¢ Escalera extensible 9m, 5 d√≠as trabajos altura",
          "‚Ä¢ 3 arneses + l√≠neas vida, 1 mes seguridad",
          "",
          "üöú MAQUINARIA PESADA:",
          "‚Ä¢ Retroexcavadora excavaci√≥n fundaci√≥n, 4 d√≠as completos",
          "‚Ä¢ Minicargador limpieza terreno, 2 d√≠as",
          "‚Ä¢ Volqueta transporte tierra, 6 viajes",
          "‚Ä¢ Motosierra desmonte √°rboles finca, 5 d√≠as", // ‚Üê NUEVO
          "",
          "üíß BOMBEO Y DRENAJE:",
          "‚Ä¢ Bomba achique sumergible fundaci√≥n inundada, 1 semana", // ‚Üê MODIFICADO (sin "s√≥tano")
          "‚Ä¢ Motobomba desag√ºe excavaci√≥n, 3 d√≠as",
          "‚Ä¢ Motobomba gasolina agua de quebrada finca, 1 semana", // ‚Üê NUEVO
          "",
          "üß∞ HERRAMIENTAS ESPECIALES:",
          "‚Ä¢ 5 carretillas obra reforzadas, 2 meses",
          "‚Ä¢ Cortadora cer√°mica profesional mesa, 1 semana",
          '‚Ä¢ Sierra circular mesa 10", 5 d√≠as carpinter√≠a',
          '‚Ä¢ Dobladora varillas hasta 1/2", 1 semana estructura',
        ],
      };

      window.showHelpModal = function () {
        const conceptSelect = document.getElementById("conceptPayments");
        const selectedConcept = conceptSelect.value;

        if (
          !selectedConcept ||
          selectedConcept === "otro" ||
          selectedConcept === ""
        ) {
          alert("Por favor selecciona un Concepto primero");
          return;
        }

        const examples = helpExamples[selectedConcept];
        if (!examples) {
          alert("No hay ejemplos disponibles para este concepto");
          return;
        }

        const modal = document.getElementById("helpModal");
        const title = document.getElementById("helpModalTitle");
        const list = document.getElementById("helpModalList");

        title.textContent = `üí° Ejemplos para: ${selectedConcept}`;

        list.innerHTML = examples.map((ex) => `<li>${ex}</li>`).join("");

        modal.classList.add("active");
      };

      window.closeHelpModal = function (event) {
        const modal = document.getElementById("helpModal");
        if (!event || event.target === modal) {
          modal.classList.remove("active");
        }
      };
    </script>

    <!-- This loads the Excel export library -->
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  </body>
</html>
